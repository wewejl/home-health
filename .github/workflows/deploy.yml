# Home-Health è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# æ„å»ºæˆåŠŸåè‡ªåŠ¨åœ¨æœåŠ¡å™¨ä¸Šé‡å¯æœåŠ¡
# ä½¿ç”¨è‡ªæ‰˜ç®¡ Runnerï¼Œæ— éœ€ SSH è¿æ¥

name: Deploy to Server

on:
  workflow_run:
    workflows: ["Build Docker Images"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    # åªåœ¨æ„å»ºæˆåŠŸåæ‰§è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # ä½¿ç”¨åŒä¸€å°è‡ªæ‰˜ç®¡ Runnerï¼ˆç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
    runs-on: self-hosted

    steps:
      - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        run: |
          set -e
          echo "=== å¼€å§‹éƒ¨ç½² ==="

          # éƒ¨ç½²ç›®å½•
          DEPLOY_DIR="/opt/home-health"
          cd "$DEPLOY_DIR" || exit 1

          # æ›´æ–° docker-compose.yml ä½¿ç”¨æœ¬åœ°æ„å»ºçš„é•œåƒ
          sed -i 's|wewejl/home-health-backend:latest|home-health-backend:latest|g' docker-compose.yml
          sed -i 's|wewejl/home-health-frontend:latest|home-health-frontend:latest|g' docker-compose.yml

          # å¯åŠ¨æœåŠ¡
          docker compose up -d

          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f

          echo "=== éƒ¨ç½²å®Œæˆ ==="

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          docker compose ps

      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10

          # æ£€æŸ¥åç«¯å¥åº·
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8100/health || echo "000")
          echo "åç«¯çŠ¶æ€ç : ${BACKEND_STATUS}"

          if [[ "${BACKEND_STATUS}" == "200" ]]; then
            echo "âœ… åç«¯æœåŠ¡å¥åº·"
          else
            echo "âŒ åç«¯æœåŠ¡å¼‚å¸¸"
            curl -v http://localhost:8100/health || true
            exit 1
          fi

          # æ£€æŸ¥å‰ç«¯
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/ || echo "000")
          echo "å‰ç«¯çŠ¶æ€ç : ${FRONTEND_STATUS}"

          if [[ "${FRONTEND_STATUS}" == "200" ]]; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·"
          else
            echo "âš ï¸ å‰ç«¯æœåŠ¡å¯èƒ½éœ€è¦æ£€æŸ¥"
          fi

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "è®¿é—®åœ°å€: http://123.206.232.231/"
