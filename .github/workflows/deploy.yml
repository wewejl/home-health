# Home-Health è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
# é•œåƒæž„å»ºæˆåŠŸåŽè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨

name: Deploy to Server

on:
  workflow_run:
    workflows: ["Build Docker Images"]
    types: [completed]
    branches: [main, develop]

env:
  # éƒ¨ç½²ç›®å½•
  DEPLOY_PATH: /opt/home-health
  # GitHub ç”¨æˆ·åï¼ˆéœ€è¦ä¸Ž build.yml ä¿æŒä¸€è‡´ï¼‰
  GITHUB_USERNAME: ${{ github.repository_owner }}

jobs:
  deploy:
    # åªåœ¨æž„å»ºæˆåŠŸåŽæ‰§è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: èŽ·å–åˆ†æ”¯ä¿¡æ¯
        id: branch_info
        run: |
          # èŽ·å–è§¦å‘çš„åˆ†æ”¯å
          if [[ "${{ github.event.workflow_run.event }}" == "pull_request" ]]; then
            BRANCH="${{ github.event.workflow_run.pull_request.head.ref }}"
          else
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "éƒ¨ç½²åˆ†æ”¯: ${BRANCH}"

      - name: è®¾ç½®é•œåƒæ ‡ç­¾
        id: image_tag
        run: |
          # ä½¿ç”¨åˆ†æ”¯åå’Œ Git SHA ä½œä¸ºæ ‡ç­¾
          if [[ "${{ steps.branch_info.outputs.branch }}" == "main" ]]; then
            TAG="latest"
          else
            TAG="${{ steps.branch_info.outputs.branch }}-latest"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "é•œåƒæ ‡ç­¾: ${TAG}"

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e

            echo "=== å¼€å§‹éƒ¨ç½² ==="
            echo "éƒ¨ç½²åˆ†æ”¯: ${{ steps.branch_info.outputs.branch }}"
            echo "é•œåƒæ ‡ç­¾: ${{ steps.image_tag.outputs.tag }}"

            # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
            sudo mkdir -p ${{ env.DEPLOY_PATH }}
            sudo chown -R ${{ secrets.DEPLOY_USER }}:${{ secrets.DEPLOY_USER }} ${{ env.DEPLOY_PATH }}

            cd ${{ env.DEPLOY_PATH }}

            # åˆ›å»º .env æ–‡ä»¶ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
            if [ ! -f .env ]; then
              echo "åˆ›å»º .env æ–‡ä»¶..."
              cat > .env << 'ENVEOF'
            GITHUB_USERNAME=${{ github.repository_owner }}
            IMAGE_TAG=${{ steps.image_tag.outputs.tag }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            LLM_API_KEY=${{ secrets.LLM_API_KEY }}
            ALIYUN_SMS_ACCESS_KEY_ID=${{ secrets.ALIYUN_SMS_ACCESS_KEY_ID }}
            ALIYUN_SMS_ACCESS_KEY_SECRET=${{ secrets.ALIYUN_SMS_ACCESS_KEY_SECRET }}
            ENVEOF
            else
              # æ›´æ–°é•œåƒæ ‡ç­¾
              sed -i "s/IMAGE_TAG=.*/IMAGE_TAG=${{ steps.image_tag.outputs.tag }}/" .env
            fi

            # æ‹‰å– docker-compose.yml
            echo "æ›´æ–° docker-compose.yml..."
            cat > docker-compose.yml << 'COMPOSEEOF'
            $(cat deployment/docker-compose.yml | sed 's/\${GITHUB_USERNAME}/${{ github.repository_owner }}/g' | sed "s/\${IMAGE_TAG:-latest}/${{ steps.image_tag.outputs.tag }}/g")
            COMPOSEEOF

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
            docker compose pull

            # å¯åŠ¨æœåŠ¡
            echo "å¯åŠ¨æœåŠ¡..."
            docker compose up -d

            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f

            echo "=== éƒ¨ç½²å®Œæˆ ==="

      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30

          echo "æ£€æŸ¥åŽç«¯å¥åº·çŠ¶æ€..."
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:8100/health || echo "000")
          echo "åŽç«¯çŠ¶æ€ç : ${BACKEND_STATUS}"

          if [[ "${BACKEND_STATUS}" == "200" ]]; then
            echo "âœ… åŽç«¯æœåŠ¡å¥åº·"
          else
            echo "âŒ åŽç«¯æœåŠ¡å¼‚å¸¸"
            exit 1
          fi

          echo "æ£€æŸ¥å‰ç«¯æœåŠ¡..."
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}/ || echo "000")
          echo "å‰ç«¯çŠ¶æ€ç : ${FRONTEND_STATUS}"

          if [[ "${FRONTEND_STATUS}" == "200" ]]; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·"
          else
            echo "âš ï¸ å‰ç«¯æœåŠ¡å¯èƒ½éœ€è¦æ£€æŸ¥"
          fi

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "åˆ†æ”¯: ${{ steps.branch_info.outputs.branch }}"
          echo "é•œåƒæ ‡ç­¾: ${{ steps.image_tag.outputs.tag }}"
          echo "è®¿é—®åœ°å€: http://${{ secrets.DEPLOY_HOST }}/"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
