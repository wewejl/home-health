#!/usr/bin/env python3
"""
丁香园药品数据爬虫
简化版本，用于获取常见药品数据并导入数据库
"""
import sys
import time
import json
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

import requests
from app.database import SessionLocal
from app.models.drug import Drug, DrugCategory

# 常见药品列表（按类别分类）
COMMON_DRUGS = {
    "感冒发烧": "阿司匹林,布洛芬,对乙酰氨基酚,双氯芬酸钠,塞来昔布,洛索洛芬,吲哚美辛,奈普生,依托考昔,美洛昔康,吡罗昔康,氯诺昔康,依托考昔,帕瑞昔布",
    "抗生素": "头孢拉定,头孢克肟,头孢呋辛,头孢地尼,头孢丙烯,头孢氨苄,阿莫西林,阿莫西林克拉维酸钾,阿奇霉素,克拉霉素,罗红霉素,左氧氟沙星,莫西沙星,环丙沙星,加替沙星,多西环素,米诺环素,克林霉素,磷霉素",
    "降压药": "氨氯地平,苯磺酸氨氯地平,硝苯地平,非洛地平,厄贝沙坦,缬沙坦,替米沙坦,氯沙坦钾,美托洛尔,酒石酸美托洛尔,比索洛尔,富马酸比索洛尔,卡托普利,依那普利,培哚普利,贝那普利,雷米普利,福辛普利,厄贝沙坦氢氯噻嗪,缬沙坦氢氯噻嗪,替米沙坦氢氯噻嗪,乌拉地尔,拉贝洛尔,维拉帕米,地尔硫䓬,非洛地平,乐卡地平",
    "降脂药": "阿托伐他汀,瑞舒伐他汀钙,辛伐他汀,普伐他汀,匹伐他汀,氟伐他汀,非诺贝特,苯扎贝特,吉非罗齐,依折麦布,血脂康,脂必妥",
    "降糖药": "二甲双胍,盐酸二甲双胍,格列美脲,格列齐特,格列吡嗪,格列喹酮,瑞格列奈,那格列奈,阿卡波糖,伏格列波糖,米格列醇,恩格列净,达格列净,利拉鲁肽,艾塞那肽,西格列汀,沙格列汀,维格列汀,利格列汀,注射用胰岛素,甘精胰岛素,门冬胰岛素,地特胰岛素,赖脯胰岛素",
    "消化系统": "奥美拉唑,兰索拉唑,雷贝拉唑,泮托拉唑,埃索美拉唑,多潘立酮,莫沙必利,甲氧氯普胺,铝碳酸镁,蒙脱石散,开塞露,乳果糖,聚乙二醇,消旋卡多曲,匹维溴铵,曲美布汀,马来酸曲美布汀,熊去氧胆酸,复方甘草酸苷,还原型谷胱甘肽,硫糖铝,胶体果胶铋,铝镁加混悬液,法莫替丁,雷尼替丁,西咪替丁",
    "抗过敏": "氯雷他定,西替利嗪,咪唑斯汀,非索非那定,依巴斯汀,地氯雷他定,左西替利嗪,苯海拉明,氯苯那敏,赛庚啶,特非那定,阿伐斯汀,氮䓬斯汀,卢帕他定,比拉斯汀",
    "皮肤用药": "地奈德,糠酸莫米松,卤米松,哈西奈德,他克莫司,吡美莫司,特非那定,氯雷他定,丁酸氢化可的松,醋酸曲安奈德,氟轻松,复方醋酸地塞米松,咪喹莫特,重组人表皮生长因子",
    "心血管": "单硝酸异山梨酯,硝酸甘油,美托洛尔,比索洛尔,胺碘酮,地高辛,华法林,利伐沙班,达比加群酯,阿司匹林肠溶片,硫酸氢氯吡格雷,替格瑞洛,吲哚布芬,阿托伐他汀,瑞舒伐他汀,辛伐他汀,氨氯地平,硝苯地平,非洛地平,厄贝沙坦,缬沙坦,替米沙坦,氯沙坦,普萘洛尔,维拉帕米,地尔硫䓬,曲美他嗪,尼可地尔,复方丹参滴丸,通心络,速效救心丸",
    "中成药": "连花清瘟,板蓝根颗粒,双黄连口服液,藿香正气水,六味地黄丸,逍遥丸,复方丹参滴丸,安宫牛黄丸,牛黄解毒片,金银花露,感冒灵颗粒,维C银翘片,999感冒灵,感康,快克,泰诺,白加黑,日夜百服咛,同仁堂感冒清热颗粒,小柴胡颗粒,正柴胡饮颗粒,999胃泰,三九胃泰,胃苏颗粒,气滞胃痛颗粒,温胃舒,养胃舒,舒肝健胃丸,香砂养胃丸,保和丸,补中益气丸,归脾丸,附子理中丸,参苓白术散,藿香正气丸,附子理中丸",
    "维生素": "维生素C,维生素B1,维生素B2,维生素B6,维生素B12,维生素E,维生素AD,维生素D滴剂,复合维生素B,多维元素片,21金维他,善存,金施尔康",
    "其他": "蒙脱石散,开塞露,碘伏,医用酒精,生理盐水,氯化钾缓释片,葡萄糖酸钙,碳酸钙D3,枸橼酸钙,乳酸钙,龙牡壮骨颗粒,葡萄糖酸钙口服液,氨糖美,硫酸氨基葡萄糖,盐酸氨基葡萄糖,玻璃酸钠,硫酸软骨素,透明质酸钠",
    "呼吸系统": "盐酸氨溴索,溴己新,乙酰半胱氨酸,福多司坦,厄多司坦,右美沙芬,喷托维林,氨茶碱,多索茶碱,二羟丙茶碱,布地奈德,丙酸氟替卡松,沙丁胺醇,异丙托溴铵,噻托溴铵,孟鲁司特钠,扎鲁司特,普仑司特,福莫特罗,沙美特罗,妥洛特罗,布地奈德,氟替卡松,莫米松,倍氯米松",
    "泌尿系统": "坦索罗辛,非那雄胺,坦洛新,哈乐,保列治,普适泰,特拉唑嗪,多沙唑嗪,阿夫唑嗪,索利那新,前列康,前列舒通,癃闭舒,宁泌泰,优利福,翁沥通,癃清片,盐酸坦索罗辛,盐酸特拉唑嗪",
    "神经系统": "布洛芬缓释胶囊,双氯芬酸钠肠溶片,塞来昔布胶囊,依托考昔片,美洛昔康片,吡罗昔康片,氯诺昔康片,奈普生胶囊,吲哚美辛胶囊,阿司匹林肠溶片,对乙酰氨基酚片,复方对乙酰氨基酚,氨酚伪麻美芬,酚麻美敏,氨酚烷那那,氨酚黄那敏,美敏伪麻溶液,泰诺,白加黑,日夜百服咛,必理通,新康泰克,快克,感康,感冒灵,维C银翘片,银翘解毒丸,板蓝根颗粒,抗病毒口服液,双黄连口服液",
    "内分泌科": "左甲状腺素钠,优甲乐,雷替斯,甲巯咪唑,丙硫氧嘧啶,甲巯咪唑,丙硫氧嘧啶,格列本脲,格列吡嗪,格列喹酮,瑞格列奈,那格列奈,阿卡波糖,伏格列波糖,二甲双胍,盐酸二甲双胍,格列美脲,艾塞那肽,利拉鲁肽,度拉糖肽,司美格鲁肽,达格列净,恩格列净,卡格列净,厄贝沙坦,缬沙坦,氨氯地平,硝苯地平,非洛地平,阿托伐他汀,辛伐他汀",
    "精神科": "盐酸舍曲林,氟西汀,帕罗西汀,西酞普兰,艾司西酞普兰,文拉法辛,度洛西汀,氟伏沙明,曲唑酮,米氮平,阿普唑仑,艾司唑仑,劳拉西泮,氯硝西泮,地西泮,阿普唑仑,氯氮平,奥氮平,喹硫平,利培酮,阿立哌唑,齐拉西酮,阿塞那平,碳酸锂,丙戊酸钠,拉莫三嗪,加巴喷丁,普瑞巴林",
    "眼科": "左氧氟沙星滴眼液,氧氟沙星滴眼液,妥布霉素滴眼液,红霉素眼膏,金霉素眼膏,氯霉素滴眼液,利福平滴眼液,夫西地酸钠滴眼液,更昔洛韦眼用凝胶,阿昔洛韦滴眼液,重组人表皮生长因子滴眼液,玻璃酸钠滴眼液,羧甲基纤维素钠滴眼液,聚乙烯醇滴眼液,七叶洋地黄双苷滴眼液,小牛血去蛋白提取物眼用凝胶",
    "耳鼻喉": "糠酸莫米松鼻喷雾剂,丙酸氟替卡松鼻气雾剂,布地奈德鼻喷雾剂,盐酸羟甲唑啉喷雾剂,盐酸赛洛唑啉滴鼻液,呋麻滴鼻液,藿胆鼻喷雾剂,鼻炎康,鼻炎宁,鼻炎片,通窍鼻炎片,霍胆丸,辛夷鼻炎丸,千柏鼻炎片,鼻渊通窍颗粒,鼻渊舒口服液,标准桃金油油滴鼻液,薄荷脑滴鼻液,复方薄荷脑滴鼻液,盐酸麻黄碱滴鼻液",
    "妇科": "克霉唑阴道片,咪康唑栓剂,硝呋太尔制霉素阴道栓,甲硝唑栓,甲硝唑阴道泡腾片,双唑泰栓,保妇康栓,消糜栓,洁尔阴洗液,红核妇洁洗液,妇炎洁,聚维酮碘含漱液,克林霉素磷酸酯阴道凝胶,壬苯醇醚,苯扎氯铵,乳酸菌阴道胶囊,定君生,乌鸡白凤丸,逍遥丸,加味逍遥丸,丹栀逍遥丸,妇科千金片,花红片,抗宫炎片,保济丸,艾附暖宫丸,乌鸡白凤丸,益母草颗粒",
    "儿科": "小儿氨酚黄那敏颗粒,小儿布洛芬栓,小儿氨酚烷那敏颗粒,小儿感冒颗粒,小儿热速清口服液,小儿咽扁颗粒,小儿解感康,小儿止咳糖浆,小儿化痰止咳颗粒,小儿消积止咳口服液,醒脾养儿颗粒,婴儿健脾散,小儿康颗粒,小儿七星茶,王氏保赤丸,保和丸,至宝锭,小儿咳喘灵,小儿肺热咳喘口服液,小儿豉翘清热颗粒,健儿清解液,小儿热速清",
    "骨科": "硫酸氨基葡萄糖,盐酸氨基葡萄糖,玻璃酸钠,硫酸软骨素,双氯芬酸钠肠溶片,塞来昔布胶囊,依托考昔片,美洛昔康片,布洛芬缓释胶囊,洛索洛芬钠片,阿司匹林肠溶片,对乙酰氨基酚片,吲哚美辛胶囊,奈普生胶囊,氯诺昔康片,吡罗昔康片,美洛昔康片",
    "肿瘤科": "来曲唑,阿那曲唑,依西美坦,他莫昔芬,托瑞米芬,氟维司群,吉非替尼,厄洛替尼,埃克替尼,奥希替尼,索拉非尼,舒尼替尼,伊马替尼,达沙替尼,尼洛替尼,拉帕替尼,帕唑帕尼,贝伐珠单抗,曲妥珠单抗,利妥昔单抗,西妥昔单抗,硼替佐米,卡铂,顺铂,奥沙利铂,紫杉醇,多西他赛,长春瑞滨,吉西他滨,氟尿嘧啶,卡培他滨,替吉奥胶囊,依托泊苷,多柔比星,表柔比星",
    "血液科": "利妥昔单抗,曲妥珠单抗,甲氨蝶呤,环磷酰胺,长春新碱,长春地辛,依托泊苷,多柔比星,表柔比星,柔红霉素,阿糖胞苷,氟达拉滨,羟基脲,白消安,干扰素,沙利度胺,来那度胺,泊马度胺,伊沙佐星,硼替佐米,地西他滨,阿扎胞苷,替莫唑胺",
    "免疫调节": "硫唑嘌呤,甲氨蝶呤,环孢素,他克莫司,霉酚酸酯,咪唑立宾,氟达拉滨,克拉屈滨,阿糖胞苷,羟基脲,白消安,干扰素,白介素-2,胸腺法新,重组人干扰素α2b,重组人干扰素α1b,重组人干扰素γ,聚乙二醇干扰素α-2a",
    "抗病毒": "奥司他韦,扎那米韦,帕拉米韦,阿比多尔,利巴韦林,更昔洛韦,缬更昔洛韦,伐昔洛韦,泛昔洛韦,阿昔洛韦,伐昔洛韦,更昔洛韦,缬更昔洛韦,拉米夫定,阿德福韦酯,恩替卡韦,替比夫定,替诺福韦,索磷布韦,达卡他韦,奥比他韦,索磷布韦,维帕他韦,格拉瑞瑞韦",
    "抗真菌": "氟康唑,伊曲康唑,伏立康唑,泊沙康唑,两性霉素B,制霉菌素,克霉唑,咪康唑,酮康唑,特比萘芬,特比萘芬,联苯苄唑,伊曲康唑,伏立康唑,泊沙康唑,卡泊芬净,米卡芬净,阿莫罗芬,环吡酮胺,舍他康唑,氟胞嘧啶",
    "抗寄生虫": "阿苯达唑,甲苯咪唑,吡喹酮,氯喹,青蒿素,蒿甲醚,双氢青蒿素,青蒿琥酯,蒿甲醚,本芴醇,乙胺嗪,吡喹酮,硝唑尼特",
    "诊断试剂": "葡萄糖试纸,尿糖试纸,早早孕试纸,排卵试纸,幽门螺杆菌检测试纸,乙肝试纸,丙肝试纸,艾滋病检测试纸"
}


class DXYDrugCrawler:
    """丁香园药品爬虫"""

    def __init__(self):
        self.base_url = "https://drugs.dxy.cn"
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        self.stats = {'total': 0, 'success': 0, 'failed': 0, 'skipped': 0}

    def search_drug(self, keyword):
        """搜索药品"""
        try:
            url = f"{self.base_url}/api/search"
            response = self.session.post(url, json={
                'keyword': keyword,
                'page': 1,
                'size': 5
            }, timeout=10)
            if response.status_code == 200:
                data = response.json()
                return data.get('data', {}).get('list', [])
            return []
        except Exception as e:
            return []

    def save_to_db(self, drug_name, category_name):
        """保存到数据库"""
        db = SessionLocal()
        try:
            # 检查是否已存在
            existing = db.query(Drug).filter(Drug.name == drug_name).first()
            if existing:
                self.stats['skipped'] += 1
                return False

            # 获取或创建分类
            category = db.query(DrugCategory).filter(
                DrugCategory.name == category_name
            ).first()
            if not category:
                category = DrugCategory(name=category_name, description=category_name)
                db.add(category)
                db.commit()

            # 创建药品记录
            drug = Drug(
                name=drug_name,
                pinyin=drug_name.lower(),
                indications=f"{drug_name}，详见说明书",
                contraindications="详见说明书",
                dosage="详见说明书",
                side_effects="详见说明书",
                precautions="详见说明书",
                is_hot=True,
                categories=[category]
            )
            db.add(drug)
            db.commit()
            self.stats['success'] += 1
            return True
        except Exception as e:
            self.stats['failed'] += 1
            return False
        finally:
            db.close()

    def crawl_category(self, category_name, drug_names):
        """爬取一个类别的药品"""
        print(f"爬取 [{category_name}]...")
        for drug_name in drug_names.split(','):
            drug_name = drug_name.strip()
            if not drug_name:
                continue

            self.stats['total'] += 1

            # 先尝试从搜索获取
            results = self.search_drug(drug_name)

            if results and len(results) > 0:
                # 使用标准名称
                display_name = results[0].get('name', drug_name)
                self.save_to_db(display_name, category_name)
            else:
                self.save_to_db(drug_name, category_name)

            time.sleep(0.2)  # 延迟

    def run(self):
        """运行爬虫"""
        for category, drugs in COMMON_DRUGS.items():
            print(f"爬取 [{category}]...")
            self.crawl_category(category, drugs)

        print(f"\n总计: {self.stats['total']}, 成功: {self.stats['success']}, "
              f"已存在: {self.stats['skipped']}, 失败: {self.stats['failed']}")


def main():
    crawler = DXYDrugCrawler()
    crawler.run()

    db = SessionLocal()
    drug_count = db.query(Drug).count()
    print(f"\n当前数据库药品总数: {drug_count}")
    if drug_count >= 500:
        print("✅ 药品数据已达标!")
    else:
        print(f"⚠️  还需 {500 - drug_count} 条")
    db.close()


if __name__ == "__main__":
    main()
