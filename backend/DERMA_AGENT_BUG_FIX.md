# DermaAgent çŠ¶æ€ç®¡ç† Bug ä¿®å¤æŠ¥å‘Š

## ğŸ”´ é—®é¢˜æè¿°

ä»æ—¥å¿—åˆ†æå‘ç°ï¼ŒDermaAgent æ¯æ¬¡å¯¹è¯éƒ½åœ¨**é‡ç½®çŠ¶æ€**ï¼Œå¯¼è‡´ï¼š
1. å·²æå–çš„ä¿¡æ¯ï¼ˆ`chief_complaint`, `skin_location`ï¼‰ä¸¢å¤±
2. `questions_asked` è®¡æ•°è¢«é‡ç½®ä¸º 0
3. Agent æ— æ³•åˆ¤æ–­ä½•æ—¶è¿›å…¥æ€»ç»“é˜¶æ®µ
4. ç”¨æˆ·ä½“éªŒå·®ï¼Œé‡å¤è¯¢é—®ç›¸åŒé—®é¢˜

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜ 1ï¼šFastAPI StreamingResponse + æ•°æ®åº“ä¼šè¯ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼ˆä¸»è¦é—®é¢˜ï¼‰

**æ–‡ä»¶ï¼š** `backend/app/routes/sessions.py` å’Œ `backend/app/routes/derma.py`

å½“ä½¿ç”¨ `StreamingResponse` æ—¶ï¼ŒFastAPI çš„ä¾èµ–æ³¨å…¥ï¼ˆ`db: Session = Depends(get_db)`ï¼‰ä¼šåœ¨è¯·æ±‚å¤„ç†å‡½æ•°è¿”å›æ—¶**ç«‹å³å…³é—­æ•°æ®åº“ä¼šè¯**ï¼Œè€Œç”Ÿæˆå™¨å†…éƒ¨çš„ä»£ç ï¼ˆåŒ…æ‹¬çŠ¶æ€ä¿å­˜ï¼‰è¿˜æ²¡æ‰§è¡Œï¼

```python
# é—®é¢˜ä»£ç ï¼š
async def stream_agent_response(
    ...
    db: Session,  # âŒ è¿™ä¸ªæ•°æ®åº“ä¼šè¯åœ¨ StreamingResponse è¿”å›åå°±å…³é—­äº†
    ...
):
    ...
    # è¿™æ®µä»£ç åœ¨ç”Ÿæˆå™¨ä¸­æ‰§è¡Œï¼Œæ­¤æ—¶ db å·²ç»å…³é—­ï¼
    session.agent_state = final_state
    db.commit()  # âŒ ä¼šè¯å·²å…³é—­ï¼Œcommit å¤±æ•ˆ
```

### é—®é¢˜ 2ï¼šå‰ç«¯å†å²è¦†ç›–æ•°æ®åº“çŠ¶æ€ï¼ˆæ¬¡è¦é—®é¢˜ï¼‰

**æ–‡ä»¶ï¼š** `backend/app/routes/derma.py` Line 327-351

ç”¨å‰ç«¯ä¼ æ¥çš„ä¸å®Œæ•´å†å²é‡æ–°è®¡ç®— `questions_asked`ï¼Œå¯¼è‡´è®¡æ•°è¢«é‡ç½®ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šåœ¨ç”Ÿæˆå™¨å†…éƒ¨åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯

**æ–‡ä»¶ï¼š** `sessions.py` å’Œ `derma.py`

```python
async def stream_agent_response(
    ...
    session_id: str,  # âœ… æ”¹ä¸ºä¼  session_id
    ...
):
    from ..database import SessionLocal  # å¯¼å…¥æ•°æ®åº“ä¼šè¯å·¥å‚
    
    ...
    
    # åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯æ¥ä¿å­˜çŠ¶æ€ï¼ˆå…³é”®ä¿®å¤ï¼ï¼‰
    db_save = SessionLocal()
    try:
        session_obj = db_save.query(SessionModel).filter(
            SessionModel.id == session_id
        ).first()
        
        if session_obj:
            session_obj.agent_state = final_state
            db_save.commit()  # âœ… ç‹¬ç«‹ä¼šè¯ï¼Œä¸å— FastAPI ç”Ÿå‘½å‘¨æœŸå½±å“
    finally:
        db_save.close()
```

### ä¿®å¤ 2ï¼šä¿æŒæ•°æ®åº“ä¸­çš„ `questions_asked`

**æ–‡ä»¶ï¼š** `derma.py`

```python
# âš ï¸ é‡è¦ï¼šä¿æŒæ•°æ®åº“ä¸­çš„ questions_askedï¼Œä¸è¦ç”¨å‰ç«¯å†å²é‡æ–°è®¡ç®—
# æ•°æ®åº“ä¸­çš„å€¼æ˜¯æƒå¨çš„ï¼Œå› ä¸ºå®ƒè·Ÿè¸ªäº†æ‰€æœ‰å¯¹è¯è½®æ¬¡
print(f"[continue_derma_session] ä¿æŒæ•°æ®åº“ä¸­çš„è¿½é—®è½®æ¬¡: {state.get('questions_asked', 0)}")
```

## ğŸ“Š ä¿®æ”¹çš„æ–‡ä»¶

1. **`backend/app/routes/sessions.py`**
   - ä¿®æ”¹ `stream_agent_response` å‡½æ•°ç­¾åï¼Œæ”¹ä¸ºä¼ é€’ `session_id` å’Œ `agent_type`
   - åœ¨ç”Ÿæˆå™¨å†…éƒ¨åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯æ¥ä¿å­˜çŠ¶æ€
   - æ·»åŠ è°ƒè¯•æ—¥å¿—

2. **`backend/app/routes/derma.py`**
   - ä¿®æ”¹ `stream_derma_response` å‡½æ•°ç­¾åï¼Œæ”¹ä¸ºä¼ é€’ `session_id`
   - åœ¨ç”Ÿæˆå™¨å†…éƒ¨åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯æ¥ä¿å­˜çŠ¶æ€
   - ç§»é™¤ç”¨å‰ç«¯å†å²é‡æ–°è®¡ç®— `questions_asked` çš„é€»è¾‘

## ğŸ§ª éªŒè¯æ–¹æ³•

æµ‹è¯•åœºæ™¯ï¼š
1. å¼€å§‹æ–°ä¼šè¯ï¼Œæè¿°ç—‡çŠ¶ï¼š"æˆ‘é¸¡é¸¡çš®è‚¤ä¸Šä¸èˆ’æœ"
2. ç»§ç»­å¯¹è¯ï¼š"å°±æ˜¯é¾Ÿå¤´å’ŒåŒ…çš®ä¸­é—´çš„çš®è‚¤ç—’"
3. æ£€æŸ¥æ—¥å¿—ï¼š
   - âœ… `[stream_agent_response] ä¿å­˜çŠ¶æ€åˆ°æ•°æ®åº“` åº”è¯¥å‡ºç°
   - âœ… `[send_message] ä»æ•°æ®åº“æ¢å¤çš„ agent_state` åº”è¯¥æ˜¾ç¤ºéç©ºçŠ¶æ€
   - âœ… `questions_asked` åº”è¯¥ä» 1 é€’å¢åˆ° 2
   - âœ… `chief_complaint` å’Œ `skin_location` åº”è¯¥ä¿æŒ

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### FastAPI StreamingResponse ç”Ÿå‘½å‘¨æœŸé—®é¢˜

å½“ä½¿ç”¨ `StreamingResponse` æ—¶ï¼ŒFastAPI çš„è¯·æ±‚å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

1. è¯·æ±‚åˆ°è¾¾ â†’ åˆ›å»ºä¾èµ–ï¼ˆåŒ…æ‹¬ db sessionï¼‰
2. å¤„ç†å‡½æ•°æ‰§è¡Œ â†’ è¿”å› `StreamingResponse` å¯¹è±¡
3. **ä¾èµ–æ¸…ç†ï¼ˆdb.close()ï¼‰** â† æ­¤æ—¶ç”Ÿæˆå™¨è¿˜æ²¡æ‰§è¡Œï¼
4. å®¢æˆ·ç«¯å¼€å§‹è¯»å–å“åº” â†’ ç”Ÿæˆå™¨å¼€å§‹æ‰§è¡Œ
5. ç”Ÿæˆå™¨å°è¯•ä½¿ç”¨ db session â†’ âŒ å·²å…³é—­

è§£å†³æ–¹æ¡ˆï¼šåœ¨ç”Ÿæˆå™¨å†…éƒ¨åˆ›å»ºç‹¬ç«‹çš„æ•°æ®åº“ä¼šè¯ï¼Œä¸ä¾èµ– FastAPI çš„ä¾èµ–æ³¨å…¥ã€‚
