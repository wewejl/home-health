# Backend 测试工具

本目录包含用于本地调试 API 的命令行工具。

---

## 皮肤科智能体 CLI (`derma_cli.py`)

**交互式**命令行工具，用于调试皮肤科智能体 API。

### 特性

- ✅ **自动登录**：使用测试账号自动获取 Token（验证码 `000000` 测试模式始终有效）
- ✅ **会话缓存**：自动保存/恢复会话状态，下次启动可继续之前的对话
- ✅ **交互式 REPL**：像聊天一样操作，无需每次执行脚本
- ✅ **本地图片支持**：自动将 jpg/png/webp 图片转为 base64
- ✅ **流式输出**：实时显示 AI 响应

---

### 安装依赖

```bash
pip install httpx
```

---

### 快速开始

```bash
# 进入测试目录
cd backend/test

# 启动交互式 CLI（使用默认测试账号）
python derma_cli.py
```

启动后会自动：
1. 使用测试账号登录（手机号 `13800138000`，验证码 `000000`）
2. 创建新的问诊会话
3. 进入交互模式

---

### 交互命令

| 命令 | 说明 | 示例 |
|------|------|------|
| `chat <消息>` | 发送文字消息 | `chat 皮肤一直发痒怎么办？` |
| `skin <图片> [描述]` | 上传皮肤照片分析 | `skin ~/Desktop/rash.jpg 手臂上的红疹` |
| `report <图片> [类型]` | 上传报告解读 | `report ./report.png 过敏原检测` |
| `history` | 查看对话历史 | |
| `status` | 查看会话状态 | |
| `reset` | 重置会话 | |
| `stream on/off` | 开关流式输出 | `stream off` |
| `help` | 显示帮助 | |
| `exit` | 退出 | |

> **提示**：直接输入文字（不带命令前缀）也会当作 `chat` 处理

---

### 完整示例

```
$ python derma_cli.py

============================================================
        皮肤科智能体 CLI - 交互模式
============================================================

💡 正在登录 (手机号: 13800138000)...
✅ 登录成功
💡 正在创建新会话...

🤖 助手: 您好！我是皮肤科AI助手，请问有什么可以帮您的？

✅ 会话已创建，ID: 550e8400-e29b-41d4-a716-446655440000

👤 你: 我手臂上起了一些红疹，有点痒

🤖 助手: 请问红疹大概持续多长时间了？是突然出现的还是逐渐发展的？

👤 你: 大概3天了，突然出现的

🤖 助手: 了解。您方便拍一张患处的照片发给我看看吗？这样我可以更准确地分析情况。

👤 你: skin ~/Desktop/rash.jpg 这是今天拍的照片

💡 正在加载图片: ~/Desktop/rash.jpg
✅ 图片加载成功，正在分析...

🤖 助手: 根据您提供的照片，我观察到以下情况...

  🔬 皮肤分析结果:
     描述: 前臂内侧可见散在的红色丘疹...
     风险等级: medium
     可能情况:
       - 接触性皮炎: 可能由接触过敏原引起...
       - 湿疹: 与皮肤屏障功能受损有关...

👤 你: report ~/Desktop/allergy_test.png 过敏原检测报告

💡 正在加载报告图片: ~/Desktop/allergy_test.png
✅ 图片加载成功，正在解读...

🤖 助手: 我来为您解读这份过敏原检测报告...

  📋 报告解读:
     报告类型: 过敏原检测报告
     摘要: 检测显示对尘螨和花粉有中度过敏反应...
     异常发现:
       - 尘螨 IgE: 偏高
       - 花粉 IgE: 轻度偏高

👤 你: status

📊 当前状态:
------------------------------
  会话 ID: 550e8400-e29b-41d4-a716-446655440000
  阶段: consultation
  进度: 60%
  历史消息: 8 条
  流式输出: 开启
------------------------------

👤 你: exit

💡 正在保存会话...
✅ 再见！
```

---

### 启动参数

```bash
python derma_cli.py [选项]
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--base-url` | API 地址 | `http://localhost:8000` |
| `--phone` | 测试手机号 | `13800138000` |
| `--code` | 验证码 | `000000` |
| `--clear-cache` | 清除缓存重新开始 | - |

**示例：**

```bash
# 连接远程服务器
python derma_cli.py --base-url http://192.168.1.100:8000

# 使用其他手机号
python derma_cli.py --phone 13900139000

# 清除缓存，重新登录
python derma_cli.py --clear-cache
```

---

### 会话缓存

CLI 会将会话状态保存到 `~/.derma_cli/session.json`，包括：
- Token
- 会话 ID
- 对话历史

下次启动时会自动恢复。使用 `--clear-cache` 可清除缓存重新开始。

---

### 常见问题

**Q: 提示"登录失败"？**  
A: 确保后端服务已启动，且 `/auth/login` 接口正常。

**Q: 图片加载失败？**  
A: 检查文件路径是否正确，支持 `~` 展开。格式必须是 jpg/png/webp。

**Q: 如何退出？**  
A: 输入 `exit`、`quit` 或按 `Ctrl+C`。

**Q: 如何查看完整响应 JSON？**  
A: 使用 `stream off` 关闭流式输出，会显示完整的格式化 JSON。
