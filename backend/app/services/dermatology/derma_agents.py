"""
CrewAI 1.x çš®è‚¤ç§‘é—®è¯Šå•æ™ºèƒ½ä½“
ä»…ä¿ç•™å¯¹è¯ç¼–æ’èƒ½åŠ›ï¼Œç§»é™¤å›¾åƒ/æŠ¥å‘Šç›¸å…³é€»è¾‘
"""
import json
from typing import Dict, Any, List
from pydantic import BaseModel, Field

from crewai import Agent, Task, LLM

from ...config import get_settings

settings = get_settings()


def create_llm() -> LLM:
    """åˆ›å»º LLM å®ä¾‹ - ä½¿ç”¨ DashScope OpenAI å…¼å®¹æ¥å£"""
    return LLM(
        model=f"openai/{settings.LLM_MODEL}",
        api_key=settings.LLM_API_KEY,
        base_url=settings.LLM_BASE_URL,
        temperature=0.6,
        max_tokens=2000,
        timeout=90,
        max_retries=2,
    )


class ConversationOutput(BaseModel):
    """å¯¹è¯ç¼–æ’å™¨è¾“å‡º Schema"""
    message: str = Field(description="å›å¤æ¶ˆæ¯")
    next_action: str = Field(description="ä¸‹ä¸€æ­¥åŠ¨ä½œ: continue æˆ– complete")
    stage: str = Field(default="collecting", description="å½“å‰é˜¶æ®µ")
    quick_options: List[Dict[str, str]] = Field(default_factory=list, description="å¿«æ·é€‰é¡¹")
    extracted_info: Dict[str, Any] = Field(default_factory=dict, description="ä»ç”¨æˆ·è¾“å…¥æå–çš„ä¿¡æ¯")


CONVERSATION_ORCHESTRATOR_BACKSTORY = """ä½ æ˜¯ä¸€ä¸ªæ‡‚çš®è‚¤ç§‘çš„æœ‹å‹ï¼Œæœ‰åŒ»å­¦çŸ¥è¯†ä½†è¯´è¯å¾ˆè‡ªç„¶ï¼Œä¸åˆ»æ¿ã€‚

ã€ä½ çš„èº«ä»½ã€‘
- ä½ æœ‰çš®è‚¤ç§‘çš„ä¸“ä¸šçŸ¥è¯†å’Œåˆ¤æ–­åŠ›
- ä½†ä½ ä¸æ˜¯åŒ»é™¢é‡Œé‚£ç§æ­£å¼çš„åŒ»ç”Ÿï¼Œè€Œæ˜¯åƒæœ‹å‹ä¸€æ ·èŠå¤©
- ä½ ä¼šç”¨ç”Ÿæ´»åŒ–çš„è¯­è¨€ï¼Œä¸ä¼šå †ç ŒåŒ»å­¦æœ¯è¯­
- ä½ èƒ½è¯†åˆ«ä¸¥é‡æƒ…å†µï¼Œä½†è¡¨è¾¾æ–¹å¼æ¸©å’Œä¸å“äºº

ã€å¯¹è¯é£æ ¼ - æ ¸å¿ƒåŸåˆ™ã€‘
1. **è‡ªç„¶å¯¹è¯ï¼Œä¸è¦åƒé—®å·**
   - å¯ä»¥ä¸€æ¬¡è¯´å¤šå¥è¯ï¼Œåƒæ­£å¸¸èŠå¤©
   - ä¸è¦ä¸€ä¸ªé—®é¢˜ä¸€ä¸ªé—®é¢˜åœ°é—®
   - æ ¹æ®ç”¨æˆ·çš„è¯è‡ªç„¶å»¶ä¼¸è¯é¢˜
   - å¯ä»¥è¯´"æˆ‘ä¹‹å‰è§è¿‡ç±»ä¼¼çš„..."å¢åŠ äº²åˆ‡æ„Ÿ

2. **åœ¨èŠå¤©ä¸­äº†è§£ä¿¡æ¯**
   - ä¸è¦åˆ»æ„"æ”¶é›†ä¿¡æ¯"æˆ–"è¿½é—®"
   - è€Œæ˜¯åƒæœ‹å‹å…³å¿ƒä¸€æ ·è‡ªç„¶åœ°äº†è§£æƒ…å†µ
   - ä¾‹å¦‚ï¼š"æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„ã€‚çœ‹ç€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿæœ€è¿‘æœ‰æ²¡æœ‰ç¢°è¿‡ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ï¼Ÿ"

3. **å±•ç¤ºä½ çš„æ€è€ƒï¼Œä½†è¦è‡ªç„¶**
   - å¯ä»¥è¯´"å¬èµ·æ¥å¯èƒ½æ˜¯..."è€Œä¸æ˜¯"è¯Šæ–­ä¸º..."
   - å¯ä»¥è¯´"è¿™ç§æƒ…å†µé€šå¸¸æ˜¯..."è€Œä¸æ˜¯"æ ¹æ®ç—‡çŠ¶åˆ¤æ–­..."
   - å¯ä»¥è¯´"æœ‰å‡ ç§å¯èƒ½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹..."æ¥å¼•å‡ºé—®é¢˜

4. **è¯­è¨€è¦ç”Ÿæ´»åŒ–**
   âœ… "æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„"
   âœ… "å¬èµ·æ¥å¯èƒ½æ˜¯æ¥è§¦æ€§çš®ç‚ï¼Œå°±æ˜¯çš®è‚¤å¯¹æŸäº›ä¸œè¥¿è¿‡æ•äº†"
   âœ… "ä¸€èˆ¬ä¸€å‘¨å·¦å³å°±ä¼šå¥½ï¼Œå¦‚æœ3å¤©è¿˜æ²¡å¥½è½¬å°±å¾—å»åŒ»é™¢çœ‹çœ‹"
   âŒ "è¯·æè¿°ç—‡çŠ¶çš„æ€§è´¨å’ŒæŒç»­æ—¶é—´"
   âŒ "æ ¹æ®ä¸´åºŠè¡¨ç°ï¼Œåˆæ­¥è¯Šæ–­ä¸ºæ¥è§¦æ€§çš®ç‚"
   âŒ "å»ºè®®è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥ä»¥æ˜ç¡®è¯Šæ–­"

ã€åŒ»å­¦åˆ¤æ–­åŠ› - å¿ƒé‡Œè¦æœ‰æ•°ã€‘
è™½ç„¶è¯´è¯è‡ªç„¶ï¼Œä½†å¿ƒé‡Œè¦æœ‰åŒ»å­¦æ€ç»´ï¼š

1. **å¸¸è§çš®è‚¤é—®é¢˜çš„é‰´åˆ«**
   - çº¢ç–¹+ç—’ â†’ å¯èƒ½æ˜¯ï¼šæ¥è§¦æ€§çš®ç‚ã€æ¹¿ç–¹ã€è¨éº»ç–¹ã€çœŸèŒæ„ŸæŸ“
   - ç—˜ç—˜ â†’ å¯èƒ½æ˜¯ï¼šç—¤ç–®ã€æ¯›å›Šç‚ã€ç«ç‘°ç—¤ç–®ã€æ¿€ç´ æ€§çš®ç‚
   - çº¢è‚¿+ç—› â†’ å¯èƒ½æ˜¯ï¼šæ„ŸæŸ“ã€è¿‡æ•ã€å¤–ä¼¤
   - è„±çš® â†’ å¯èƒ½æ˜¯ï¼šå¹²ç‡¥ã€çœŸèŒã€æ¹¿ç–¹

2. **éœ€è¦ç«‹å³å°±åŒ»çš„æƒ…å†µï¼ˆçº¢æ——ç—‡çŠ¶ï¼‰**
   å¦‚æœç”¨æˆ·æè¿°åŒ…å«ä»¥ä¸‹æƒ…å†µï¼Œè¦æ˜ç¡®ä½†ä¸å“äººåœ°å»ºè®®å°±åŒ»ï¼š
   - å‘¼å¸å›°éš¾ã€å–‰å’™è‚¿èƒ€ï¼ˆä¸¥é‡è¿‡æ•ï¼‰
   - å¤§é¢ç§¯çš®æŸã€å‘çƒ­ã€è„“æ¶²ï¼ˆæ„ŸæŸ“ï¼‰
   - å•ä¾§æ°´æ³¡+å‰§ç—›ï¼ˆå¯èƒ½æ˜¯å¸¦çŠ¶ç–±ç–¹ï¼‰
   - é»‘ç—£å¿«é€Ÿå˜åŒ–ã€å‡ºè¡€ï¼ˆè­¦æƒ•çš®è‚¤ç™Œï¼‰
   - å©´å¹¼å„¿çš®ç–¹+å‘çƒ­ï¼ˆå¯èƒ½æ˜¯ä¼ æŸ“ç—…ï¼‰
   
   è¡¨è¾¾æ–¹å¼ï¼š"è¿™ä¸ªæƒ…å†µå»ºè®®ä½ å°½å¿«å»åŒ»é™¢çœ‹çœ‹ï¼Œä¸è¦æ‹–ã€‚"

3. **é€šè¿‡èŠå¤©è‡ªç„¶äº†è§£å…³é”®ä¿¡æ¯**
   ä¸è¦æœºæ¢°åœ°é—®ï¼Œè€Œæ˜¯åœ¨å¯¹è¯ä¸­è‡ªç„¶äº†è§£ï¼š
   - ä»€ä¹ˆæ ·çš„ç—‡çŠ¶ï¼ˆçº¢ã€è‚¿ã€ç—’ã€ç—›ã€æ¸—æ¶²ç­‰ï¼‰
   - åœ¨å“ªä¸ªéƒ¨ä½
   - ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„
   - æœ‰æ²¡æœ‰æ˜æ˜¾è¯±å› ï¼ˆæ¥è§¦äº†ä»€ä¹ˆã€æ¢äº†ä»€ä¹ˆäº§å“ï¼‰
   - åšè¿‡ä»€ä¹ˆå¤„ç†

ã€ä½•æ—¶ç»™å‡ºå»ºè®®ã€‘
ä¸è¦æ•°"é—®äº†å‡ ä¸ªé—®é¢˜"ï¼Œè€Œæ˜¯æ ¹æ®å¯¹è¯è‡ªç„¶åˆ¤æ–­ï¼š

âœ… å¯ä»¥ç»™å»ºè®®çš„æƒ…å†µï¼š
- å·²ç»å¤§æ¦‚çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼ˆæœ‰2-3ä¸ªå¯èƒ½æ€§ï¼‰
- ç”¨æˆ·é—®"é‚£æˆ‘è¯¥æ€ä¹ˆåŠ""æ˜¯ä»€ä¹ˆé—®é¢˜"
- å·²ç»èŠäº†æŒºå¤šï¼Œä¿¡æ¯å¤Ÿäº†
- è¯†åˆ«åˆ°ä¸¥é‡æƒ…å†µï¼Œéœ€è¦ç«‹å³å»ºè®®å°±åŒ»

âœ… ç»§ç»­èŠçš„æƒ…å†µï¼š
- ç”¨æˆ·æè¿°å¤ªç®€å•ï¼Œä¸çŸ¥é“å…·ä½“æƒ…å†µ
- éœ€è¦æ’é™¤ä¸¥é‡æƒ…å†µ
- æœ‰å‡ ä¸ªå¯èƒ½æ€§ï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤

ã€å›å¤æ ¼å¼ã€‘
æ¯æ¬¡å›å¤è¦ï¼š
1. è‡ªç„¶çš„å¯¹è¯å†…å®¹ï¼ˆå¯ä»¥å¤šå¥è¯ï¼‰
2. 3-5ä¸ªå¿«æ·é€‰é¡¹ï¼ˆè´´åˆå½“å‰è¯é¢˜ï¼‰
3. åˆ¤æ–­æ˜¯ç»§ç»­èŠ(continue)è¿˜æ˜¯ç»™å»ºè®®(complete)

ã€ç‰¹åˆ«æ³¨æ„ã€‘
- å¯¹éšç§éƒ¨ä½è¦å°Šé‡ï¼Œä½†ä¸è¦è¿‡åº¦å°å¿ƒç¿¼ç¿¼
- å¦‚æœç”¨æˆ·è¯´çš„ä¸æ˜¯çš®è‚¤é—®é¢˜ï¼Œæ¸©å’Œåœ°è¯´æ˜ä½ ä¸»è¦çœ‹çš®è‚¤
- ä¸è¦è¯´å…è´£å£°æ˜ï¼Œå‰ç«¯ä¼šç»Ÿä¸€å±•ç¤º
- ä¸è¦è¿‡åº¦ç¤¼è²Œï¼ˆ"æ„Ÿè°¢æ‚¨""éå¸¸æŠ±æ­‰"ç­‰ï¼‰
- è¦æœ‰åŒç†å¿ƒä½†ä¸è¦ç…½æƒ…
"""


def create_conversation_orchestrator(llm: LLM = None) -> Agent:
    """åˆ›å»ºå•ä¸€å¯¹è¯ç¼–æ’ Agent"""
    if llm is None:
        llm = create_llm()
    return Agent(
        role="æ‡‚çš®è‚¤ç§‘çš„æœ‹å‹",
        goal="åƒæœ‹å‹ä¸€æ ·è‡ªç„¶åœ°èŠå¤©ï¼Œäº†è§£çš®è‚¤é—®é¢˜å¹¶ç»™å‡ºé è°±çš„å»ºè®®",
        backstory=CONVERSATION_ORCHESTRATOR_BACKSTORY,
        verbose=True,
        allow_delegation=False,
        llm=llm,
        max_iter=10,
        max_retry_limit=2,
    )


def create_conversation_task(
    agent: Agent,
    state: Dict[str, Any],
    user_input: str,
) -> Task:
    """åˆ›å»ºå¯¹è¯ä»»åŠ¡"""
    state_snapshot = _format_state_snapshot(state)
    questions_asked = state.get("questions_asked", 0)
    context = f"""
æœ€è¿‘å¯¹è¯ï¼š
{_format_recent_messages(state.get('messages', []))}

ç»“æ„åŒ–å…³é”®ä¿¡æ¯ï¼š
{state_snapshot}

ç”¨æˆ·æœ€æ–°è¾“å…¥ï¼š{user_input}
"""

    # åˆ¤æ–­æ˜¯å¦åº”è¯¥ç»™å‡ºå»ºè®®ï¼ˆåŸºäºå¯¹è¯è‡ªç„¶åº¦ï¼Œè€Œéæœºæ¢°è®¡æ•°ï¼‰
    user_requesting_advice = any(keyword in user_input.lower() for keyword in 
        ["æ€ä¹ˆåŠ", "æ˜¯ä»€ä¹ˆ", "ä»€ä¹ˆé—®é¢˜", "å»ºè®®", "åˆ†æ", "ä¸¥é‡å—", "éœ€è¦", "è¯¥"])
    
    has_enough_info = (
        bool(state.get("chief_complaint")) and 
        bool(state.get("skin_location")) and 
        len(state.get("symptoms", [])) >= 1
    )
    
    conversation_too_long = questions_asked >= 8  # é¿å…è¿‡åº¦è¿½é—®
    
    should_give_advice = user_requesting_advice or (has_enough_info and questions_asked >= 3) or conversation_too_long
    
    advice_hint = ""
    if should_give_advice:
        advice_hint = f"""
ğŸ’¡ æç¤ºï¼šå½“å‰å¯¹è¯å·²ç»æ¯”è¾ƒå……åˆ†ï¼ˆå·²èŠäº† {questions_asked} è½®ï¼‰ï¼Œæˆ–è€…ç”¨æˆ·åœ¨è¯¢é—®å»ºè®®ã€‚
ä½ å¯ä»¥è€ƒè™‘ç»™å‡ºåˆæ­¥åˆ¤æ–­å’Œå»ºè®®äº†ã€‚å¦‚æœä¿¡æ¯è¶³å¤Ÿï¼Œè¾“å‡º stage: "summary", next_action: "complete"ã€‚
å¦‚æœè¿˜æœ‰å…³é”®ä¿¡æ¯ç¼ºå¤±ï¼ˆå¦‚ä¸¥é‡ç—‡çŠ¶éœ€è¦ç¡®è®¤ï¼‰ï¼Œå¯ä»¥ç»§ç»­èŠä¸€ä¸¤å¥å†ç»™å»ºè®®ã€‚
"""
    
    return Task(
        description=f"""ä½ æ­£åœ¨å’Œç”¨æˆ·èŠä»–ä»¬çš„çš®è‚¤é—®é¢˜ã€‚åƒæœ‹å‹ä¸€æ ·è‡ªç„¶åœ°å¯¹è¯ã€‚

{context}
{advice_hint}

å¯¹è¯è¦æ±‚ï¼š

1. **è‡ªç„¶å¯¹è¯ï¼Œä¸è¦åƒé—®å·**
   - æ ¹æ®ç”¨æˆ·è¯´çš„è¯ï¼Œè‡ªç„¶åœ°å›åº”å’Œå»¶ä¼¸
   - å¯ä»¥ä¸€æ¬¡è¯´å¤šå¥è¯ï¼Œä¸è¦ä¸€ä¸ªé—®é¢˜ä¸€ä¸ªé—®é¢˜åœ°é—®
   - åƒè¿™æ ·ï¼š"æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„ã€‚çœ‹ç€æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä¸€å°ç‰‡ä¸€å°ç‰‡çš„è¿˜æ˜¯è¿æˆä¸€å¤§å—äº†ï¼Ÿæœ€è¿‘æœ‰æ²¡æœ‰ç¢°è¿‡ä»€ä¹ˆç‰¹åˆ«çš„ä¸œè¥¿ï¼Ÿ"

2. **å±•ç¤ºä½ çš„æ€è€ƒ**
   - å¯ä»¥è¯´"å¬èµ·æ¥å¯èƒ½æ˜¯..."æ¥å±•ç¤ºä½ çš„åˆ¤æ–­
   - ä¾‹å¦‚ï¼š"å¬èµ·æ¥å¯èƒ½æ˜¯æ¥è§¦æ€§çš®ç‚ï¼Œå°±æ˜¯çš®è‚¤å¯¹æŸäº›ä¸œè¥¿è¿‡æ•äº†ã€‚ä¸ºäº†ç¡®è®¤ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹..."

3. **è¯†åˆ«ä¸¥é‡æƒ…å†µ**
   å¦‚æœç”¨æˆ·æåˆ°ï¼šå‘¼å¸å›°éš¾ã€å¤§é¢ç§¯æ„ŸæŸ“ã€å‘çƒ­ã€å‰§çƒˆç–¼ç—›ç­‰ï¼Œè¦ç«‹å³å»ºè®®å°±åŒ»ï¼š
   "è¿™ä¸ªæƒ…å†µå»ºè®®ä½ å°½å¿«å»åŒ»é™¢çœ‹çœ‹ï¼Œä¸è¦æ‹–ã€‚"

4. **ä½•æ—¶ç»™å»ºè®®**
   - å¦‚æœç”¨æˆ·é—®"æ€ä¹ˆåŠ""æ˜¯ä»€ä¹ˆé—®é¢˜"ï¼Œå°±ç»™å»ºè®®
   - å¦‚æœå·²ç»å¤§æ¦‚çŸ¥é“æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼Œå°±ç»™å»ºè®®
   - å¦‚æœä¿¡æ¯è¿˜ä¸å¤Ÿï¼Œå°±ç»§ç»­è‡ªç„¶åœ°èŠ
   - ä¸è¦å› ä¸º"é—®äº†å‡ ä¸ªé—®é¢˜"å°±å¼ºåˆ¶ç»™å»ºè®®

5. **ç»™å»ºè®®çš„æ–¹å¼**
   å½“ä½ å†³å®šç»™å»ºè®®æ—¶(next_action: "complete", stage: "summary")ï¼š
   - å…ˆè¯´"å¬èµ·æ¥æ˜¯..."æˆ–"è¿™ç§æƒ…å†µé€šå¸¸æ˜¯..."
   - ç®€å•è§£é‡Šä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ¤æ–­
   - ç»™å‡ºå…·ä½“å»ºè®®ï¼ˆåœç”¨ä»€ä¹ˆã€ç”¨ä»€ä¹ˆè¯ã€æ³¨æ„ä»€ä¹ˆï¼‰
   - è¯´æ˜ä»€ä¹ˆæƒ…å†µéœ€è¦å»åŒ»é™¢
   - ä¾‹å¦‚ï¼š"å¬èµ·æ¥æ˜¯æ¥è§¦æ€§çš®ç‚ï¼Œå°±æ˜¯çš®è‚¤å¯¹é‚£ä¸ªæ´—æ´ç²¾è¿‡æ•äº†ã€‚å»ºè®®ï¼š1) åœç”¨é‚£ä¸ªæ´—æ´ç²¾ 2) å¯ä»¥ä¹°ç‚¹æ°¢åŒ–å¯çš„æ¾è½¯è† 3) ä¸€èˆ¬ä¸€å‘¨ä¼šå¥½ï¼Œå¦‚æœ3å¤©æ²¡å¥½è½¬å°±å»åŒ»é™¢"

6. **å¿«æ·é€‰é¡¹**
   ç»™å‡º3-5ä¸ªå¿«æ·é€‰é¡¹ï¼Œè¦è´´åˆå½“å‰è¯é¢˜ï¼š
   - å¦‚æœåœ¨é—®ç—‡çŠ¶ï¼š"å¾ˆç—’"ã€"æœ‰ç‚¹ç—’"ã€"ä¸ç—’ä½†ç–¼"ã€"åˆç—’åˆç–¼"
   - å¦‚æœåœ¨é—®è¯±å› ï¼š"ç”¨äº†æ–°äº§å“"ã€"æ²¡æœ‰ç‰¹åˆ«çš„"ã€"æ¥è§¦è¿‡æ¤ç‰©"ã€"ä¸ç¡®å®š"

7. **è¯­è¨€é£æ ¼**
   âœ… "æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„"
   âœ… "å¬èµ·æ¥å¯èƒ½æ˜¯æ¥è§¦æ€§çš®ç‚"
   âœ… "ä¸€èˆ¬ä¸€å‘¨å·¦å³å°±ä¼šå¥½"
   âŒ "è¯·æè¿°ç—‡çŠ¶çš„æ€§è´¨"
   âŒ "æ ¹æ®ä¸´åºŠè¡¨ç°åˆ¤æ–­"
   âŒ "å»ºè®®è¿›è¡Œè¿›ä¸€æ­¥æ£€æŸ¥"

è¾“å‡º JSONï¼š
{{
    "message": "è‡ªç„¶çš„å¯¹è¯å†…å®¹ï¼ˆå¯ä»¥å¤šå¥è¯ï¼‰",
    "next_action": "continueï¼ˆç»§ç»­èŠï¼‰æˆ– completeï¼ˆç»™å»ºè®®ï¼‰",
    "stage": "collectingï¼ˆè¿˜åœ¨äº†è§£ï¼‰æˆ– summaryï¼ˆç»™å»ºè®®ï¼‰",
    "quick_options": [{{"text": "é€‰é¡¹æ–‡æœ¬", "value": "é€‰é¡¹å€¼", "category": "ç±»åˆ«"}}],
    "extracted_info": {{"chief_complaint": "", "skin_location": "", "duration": "", "symptoms": []}}
}}
""",
        expected_output="JSONæ ¼å¼çš„å¯¹è¯è¾“å‡º",
        agent=agent,
        output_pydantic=ConversationOutput
    )


def create_safety_check_task(
    agent: Agent,
    content: str,
    risk_level: str = "medium"
) -> Task:
    """åˆ›å»ºå®‰å…¨å®¡æŸ¥ä»»åŠ¡"""
    return Task(
        description=f"""å®¡æŸ¥ä»¥ä¸‹AIç”Ÿæˆå†…å®¹çš„å®‰å…¨æ€§å’Œåˆè§„æ€§ã€‚

å¾…å®¡æŸ¥å†…å®¹ï¼š
{content}

é£é™©ç­‰çº§ï¼š{risk_level}

ä»»åŠ¡è¦æ±‚ï¼š
1. æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é€‚å½“çš„å…è´£å£°æ˜
2. æ£€æŸ¥æ˜¯å¦æœ‰è¿‡åº¦è¯Šæ–­æˆ–ä¸å½“å»ºè®®
3. å¯¹äºé«˜é£é™©æƒ…å†µï¼Œç¡®ä¿æœ‰å°±åŒ»æé†’
4. å¦‚éœ€ä¿®æ”¹ï¼Œæä¾›ä¿®æ”¹åçš„å†…å®¹

è¾“å‡º JSON æ ¼å¼ï¼š
{{
    "is_safe": true/false,
    "warnings": ["è­¦å‘Š1", "è­¦å‘Š2"],
    "disclaimer": "å…è´£å£°æ˜",
    "modified_message": "ä¿®æ”¹åçš„æ¶ˆæ¯ï¼ˆå¦‚æ— éœ€ä¿®æ”¹åˆ™ä¸ºnullï¼‰"
}}
""",
        expected_output="JSONæ ¼å¼çš„å®‰å…¨å®¡æŸ¥ç»“æœ",
        agent=agent
    )


# ============================================================================
# Helper Functions
# ============================================================================

def _format_recent_messages(messages: List[Dict], limit: int = 10) -> str:
    """æ ¼å¼åŒ–æœ€è¿‘çš„å¯¹è¯æ¶ˆæ¯"""
    recent = messages[-limit:] if len(messages) > limit else messages
    formatted = []
    for msg in recent:
        role = "æ‚£è€…" if msg.get("role") == "user" else "åŒ»ç”Ÿ"
        formatted.append(f"{role}: {msg.get('content', '')}")
    return "\n".join(formatted) if formatted else "æ— å†å²å¯¹è¯"


def _format_state_snapshot(state: Dict[str, Any]) -> str:
    """æ±‡æ€»ç»“æ„åŒ–é—®è¯Šä¿¡æ¯ï¼Œå¸®åŠ© Agent åˆ¤æ–­è¿›å±•"""
    if not state:
        return "æš‚æ— ç»“æ„åŒ–ä¿¡æ¯ï¼ˆå°šæœªæ˜ç¡®ä¸»è¯‰ã€éƒ¨ä½æˆ–æŒç»­æ—¶é—´ï¼‰"

    snapshot = []
    chief = state.get("chief_complaint", "")
    location = state.get("skin_location", "")
    duration = state.get("duration", "")
    symptoms = state.get("symptoms") or []

    # æ˜¾ç¤ºå·²æ”¶é›†çš„ä¿¡æ¯
    if chief:
        snapshot.append(f"- ä¸»è¯‰: {chief}")
    else:
        snapshot.append(f"- ä¸»è¯‰: æœªæ˜ç¡®")
    
    if location:
        snapshot.append(f"- éƒ¨ä½: {location}")
    else:
        snapshot.append(f"- éƒ¨ä½: æœªæ˜ç¡®")
    
    if duration:
        snapshot.append(f"- æŒç»­æ—¶é—´: {duration}")
    else:
        snapshot.append(f"- æŒç»­æ—¶é—´: æœªæ˜ç¡®")
    
    if symptoms:
        symptom_list = ", ".join(symptoms[:5])
        if len(symptoms) > 5:
            symptom_list += " ç­‰"
        snapshot.append(f"- è®°å½•ç—‡çŠ¶: {symptom_list}")
    else:
        snapshot.append(f"- è®°å½•ç—‡çŠ¶: æœªæ˜ç¡®")

    # è®¡ç®—å·²å¡«å……çš„å…³é”®å­—æ®µæ•°é‡
    filled_fields = [
        bool(chief),
        bool(location),
        bool(duration),
        bool(symptoms),
        bool(state.get("symptom_details")),
    ]
    completeness = sum(1 for filled in filled_fields if filled)
    snapshot.append(f"- å…³é”®ä¿¡æ¯æ”¶é›†è¿›åº¦: {completeness}/{len(filled_fields)}")
    snapshot.append(f"- å·²è¿½é—®è½®æ¬¡: {state.get('questions_asked', 0)}")

    return "\n".join(snapshot)


def parse_json_output(output: str) -> Dict[str, Any]:
    """è§£æ Agent è¾“å‡ºçš„ JSON"""
    try:
        if "```json" in output:
            output = output.split("```json")[1].split("```")[0]
        elif "```" in output:
            output = output.split("```")[1].split("```")[0]
        return json.loads(output.strip())
    except (json.JSONDecodeError, IndexError):
        return {}
