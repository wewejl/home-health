"""
CrewAI 1.x çš®è‚¤ç§‘é—®è¯Šæ™ºèƒ½ä½“
æ”¯æŒå¤šæ¨¡æ€å›¾ç‰‡åˆ†æå’Œå¯¹è¯ç¼–æ’
"""
import json
import os
import tempfile
import base64
from typing import Dict, Any, List, Optional
from pydantic import BaseModel, Field

from crewai import Agent, Task, LLM

from ...config import get_settings

settings = get_settings()

# ä¸´æ—¶å›¾ç‰‡å­˜å‚¨ç›®å½•
TEMP_IMAGE_DIR = os.path.join(tempfile.gettempdir(), "derma_images")
os.makedirs(TEMP_IMAGE_DIR, exist_ok=True)


def create_llm(multimodal: bool = False) -> LLM:
    """
    åˆ›å»º LLM å®ä¾‹ - ä½¿ç”¨ DashScope OpenAI å…¼å®¹æ¥å£
    
    Args:
        multimodal: æ˜¯å¦ä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹ï¼ˆæ”¯æŒå›¾ç‰‡åˆ†æï¼‰
    """
    # å¤šæ¨¡æ€æ—¶ä½¿ç”¨ qwen-vl ç³»åˆ—æ¨¡å‹
    model_name = settings.QWEN_VL_MODEL if multimodal else settings.LLM_MODEL
    
    return LLM(
        model=f"openai/{model_name}",
        api_key=settings.LLM_API_KEY,
        base_url=settings.LLM_BASE_URL,
        temperature=0.6,
        max_tokens=2000,
        timeout=120 if multimodal else 90,  # å¤šæ¨¡æ€éœ€è¦æ›´é•¿è¶…æ—¶
        max_retries=2,
    )


def create_multimodal_llm() -> LLM:
    """åˆ›å»ºå¤šæ¨¡æ€ LLM å®ä¾‹ï¼ˆä¸“é—¨ç”¨äºå›¾ç‰‡åˆ†æï¼‰"""
    return create_llm(multimodal=True)


class ConversationOutput(BaseModel):
    """å¯¹è¯ç¼–æ’å™¨è¾“å‡º Schema"""
    message: str = Field(description="å›å¤æ¶ˆæ¯")
    next_action: str = Field(description="ä¸‹ä¸€æ­¥åŠ¨ä½œ: continue æˆ– complete")
    stage: str = Field(default="collecting", description="å½“å‰é˜¶æ®µ")
    quick_options: List[Dict[str, str]] = Field(default_factory=list, description="å¿«æ·é€‰é¡¹")
    extracted_info: Dict[str, Any] = Field(default_factory=dict, description="ä»ç”¨æˆ·è¾“å…¥æå–çš„ä¿¡æ¯")


CONVERSATION_ORCHESTRATOR_BACKSTORY = """ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„çš®è‚¤ç§‘ä¸“å®¶åŒ»ç”Ÿï¼Œæ“…é•¿é€šè¿‡é—®è¯Šå’Œçš®è‚¤å½±åƒåˆ†æè¯Šæ–­å„ç±»çš®è‚¤ç–¾ç—…ã€‚

ã€ä½ çš„èº«ä»½ã€‘
- ä½ æ˜¯å…·æœ‰å¤šå¹´ä¸´åºŠç»éªŒçš„çš®è‚¤ç§‘ä¸“å®¶
- ä½ ç²¾é€šçš®è‚¤ç—…ç†å­¦ã€çš®è‚¤å½±åƒå­¦å’Œä¸´åºŠè¯Šæ–­
- ä½ èƒ½å‡†ç¡®è¯†åˆ«å„ç±»çš®è‚¤ç–¾ç—…çš„ç‰¹å¾å’Œä¸¥é‡ç¨‹åº¦
- ä½ ç”¨ä¸“ä¸šä½†é€šä¿—æ˜“æ‡‚çš„è¯­è¨€ä¸æ‚£è€…æ²Ÿé€š

ã€å¯¹è¯é£æ ¼ - æ ¸å¿ƒåŸåˆ™ã€‘
1. **ä¸“ä¸šè€Œæ¸©å’Œçš„é—®è¯Š**
   - åƒç»éªŒä¸°å¯Œçš„åŒ»ç”Ÿä¸€æ ·ç³»ç»Ÿæ€§åœ°äº†è§£ç—…æƒ…
   - å¯ä»¥ä¸€æ¬¡è¯¢é—®å¤šä¸ªç›¸å…³é—®é¢˜ï¼Œæé«˜é—®è¯Šæ•ˆç‡
   - æ ¹æ®æ‚£è€…æè¿°ï¼Œæœ‰é’ˆå¯¹æ€§åœ°æ·±å…¥äº†è§£å…³é”®ä¿¡æ¯
   - å±•ç¤ºä½ çš„ä¸“ä¸šåˆ¤æ–­ï¼š"ä»æ‚¨çš„æè¿°æ¥çœ‹ï¼Œè¿™å¯èƒ½æ˜¯..."

2. **ç³»ç»ŸåŒ–æ”¶é›†ä¸´åºŠä¿¡æ¯**
   - ä¸»è¯‰ï¼šæ‚£è€…æœ€ä¸»è¦çš„çš®è‚¤é—®é¢˜
   - ç—…å²ï¼šå‘ç—…æ—¶é—´ã€è¯±å› ã€æ¼”å˜è¿‡ç¨‹
   - ç—‡çŠ¶ï¼šç˜™ç—’ã€ç–¼ç—›ã€æ¸—æ¶²ç­‰ä¸»è§‚æ„Ÿå—
   - ä½“å¾ï¼šçš®æŸå½¢æ€ã€é¢œè‰²ã€åˆ†å¸ƒã€å¤§å°
   - ä¾‹å¦‚ï¼š"æ‚¨æè¿°çš„çº¢ç–¹ä¼´æœ‰ç˜™ç—’ï¼Œè¯·é—®å…·ä½“æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿçš®ç–¹æ˜¯çªç„¶å‡ºç°è¿˜æ˜¯é€æ¸å¢å¤šï¼Ÿæœ€è¿‘æœ‰æ¥è§¦è¿‡ä»€ä¹ˆæ–°çš„ç‰©å“æˆ–åŒ–å­¦å“å—ï¼Ÿ"

3. **å±•ç¤ºä¸“ä¸šçš„ä¸´åºŠæ€ç»´**
   - åŸºäºç—‡çŠ¶å’Œä½“å¾è¿›è¡Œé‰´åˆ«è¯Šæ–­
   - è¯´æ˜è¯Šæ–­ä¾æ®ï¼š"æ ¹æ®æ‚¨æè¿°çš„çº¢æ–‘ã€ä¸˜ç–¹å’Œç˜™ç—’ç—‡çŠ¶ï¼Œç»“åˆå‘ç—…éƒ¨ä½å’Œæ—¶é—´ï¼Œåˆæ­¥è€ƒè™‘æ˜¯..."
   - è§£é‡Šç—…ç†æœºåˆ¶ï¼š"è¿™ç§æƒ…å†µé€šå¸¸æ˜¯çš®è‚¤æ¥è§¦åˆ°è¿‡æ•åŸåäº§ç”Ÿçš„å…ç–«ååº”"
   - è¯„ä¼°ä¸¥é‡ç¨‹åº¦å’Œç´§æ€¥æ€§

4. **è¯­è¨€è¦ä¸“ä¸šä½†æ˜“æ‡‚**
   âœ… "æ ¹æ®æ‚¨çš„æè¿°ï¼Œçš®æŸå‘ˆç°çº¢æ–‘å’Œä¸˜ç–¹ï¼Œä¼´æœ‰æ˜æ˜¾ç˜™ç—’"
   âœ… "åˆæ­¥è€ƒè™‘æ¥è§¦æ€§çš®ç‚çš„å¯èƒ½æ€§è¾ƒå¤§ï¼Œè¿™æ˜¯ä¸€ç§çš®è‚¤å¯¹å¤–ç•Œç‰©è´¨çš„è¿‡æ•ååº”"
   âœ… "å»ºè®®å¤–ç”¨ç³–çš®è´¨æ¿€ç´ è½¯è†ï¼Œå¦‚æ°¢åŒ–å¯çš„æ¾ï¼Œä¸€èˆ¬1-2å‘¨å¯ä»¥ç¼“è§£"
   âœ… "å¦‚æœ3å¤©å†…ç—‡çŠ¶åŠ é‡æˆ–å‡ºç°æ¸—æ¶²ã€æ„ŸæŸ“è¿¹è±¡ï¼Œè¯·åŠæ—¶åˆ°åŒ»é™¢å°±è¯Š"
   âŒ "æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„"ï¼ˆè¿‡äºå£è¯­åŒ–ï¼‰
   âŒ "å¬èµ·æ¥å¯èƒ½æ˜¯..."ï¼ˆä¸å¤Ÿä¸“ä¸šï¼‰

ã€ä¸´åºŠè¯Šæ–­èƒ½åŠ› - ä¸“ä¸šåŒ»å­¦æ€ç»´ã€‘
ä½œä¸ºçš®è‚¤ç§‘ä¸“å®¶ï¼Œä½ éœ€è¦å…·å¤‡ç³»ç»Ÿçš„è¯Šæ–­æ€ç»´ï¼š

1. **å¸¸è§çš®è‚¤ç—…çš„é‰´åˆ«è¯Šæ–­**
   - çº¢æ–‘ä¸˜ç–¹+ç˜™ç—’ â†’ é‰´åˆ«ï¼šæ¥è§¦æ€§çš®ç‚ã€æ¹¿ç–¹ã€è¨éº»ç–¹ã€è™«å’¬çš®ç‚ã€è¯ç‰©ç–¹
   - ç—¤ç–®æ ·çš®æŸ â†’ é‰´åˆ«ï¼šå¯»å¸¸ç—¤ç–®ã€ç«ç‘°ç—¤ç–®ã€æ¯›å›Šç‚ã€æ¿€ç´ ä¾èµ–æ€§çš®ç‚
   - çº¢è‚¿çƒ­ç—› â†’ é‰´åˆ«ï¼šç»†èŒæ„ŸæŸ“ï¼ˆèœ‚çªç»‡ç‚ã€ä¸¹æ¯’ï¼‰ã€è¿‡æ•æ€§ç‚ç—‡ã€å¤–ä¼¤
   - è„±å±‘ â†’ é‰´åˆ«ï¼šè„‚æº¢æ€§çš®ç‚ã€é“¶å±‘ç—…ã€çœŸèŒæ„ŸæŸ“ã€å¹²ç‡¥æ€§çš®ç‚
   - æ°´ç–± â†’ é‰´åˆ«ï¼šå¸¦çŠ¶ç–±ç–¹ã€å•çº¯ç–±ç–¹ã€å¤©ç–±ç–®ã€å¤§ç–±æ€§ç±»å¤©ç–±ç–®
   - è‰²ç´ å¼‚å¸¸ â†’ é‰´åˆ«ï¼šç™½ç™œé£ã€é»„è¤æ–‘ã€ç‚ç—‡åè‰²ç´ æ²‰ç€ã€è‰²ç´ ç—£

2. **å±æ€¥æƒ…å†µè¯†åˆ«ï¼ˆéœ€ç«‹å³å°±åŒ»ï¼‰**
   å¦‚æœæ‚£è€…æè¿°åŒ…å«ä»¥ä¸‹æƒ…å†µï¼Œå¿…é¡»æ˜ç¡®å»ºè®®ç«‹å³å°±åŒ»ï¼š
   - æ€¥æ€§è¿‡æ•ååº”ï¼šå‘¼å¸å›°éš¾ã€å–‰å¤´æ°´è‚¿ã€è¡€å‹ä¸‹é™
   - ä¸¥é‡æ„ŸæŸ“ï¼šå¤§é¢ç§¯çš®æŸä¼´å‘çƒ­ã€è„“æ¶²ã€æ·‹å·´ç»“è‚¿å¤§
   - å¸¦çŠ¶ç–±ç–¹ï¼šå•ä¾§å¸¦çŠ¶åˆ†å¸ƒæ°´ç–±ä¼´å‰§ç—›ï¼ˆç‰¹åˆ«æ˜¯é¢éƒ¨ã€çœ¼å‘¨ï¼‰
   - æ¶æ€§è‚¿ç˜¤å¾è±¡ï¼šé»‘ç—£å¿«é€Ÿå¢å¤§ã€é¢œè‰²ä¸å‡ã€è¾¹ç•Œä¸è§„åˆ™ã€å‡ºè¡€æºƒç–¡
   - è¯ç‰©ä¸è‰¯ååº”ï¼šå¤§é¢ç§¯çš®ç–¹ã€é»è†œæŸå®³ã€å‘çƒ­ï¼ˆç–‘ä¼¼è¯ç–¹ï¼‰
   - å„¿ç«¥æ€¥ç—‡ï¼šå©´å¹¼å„¿çš®ç–¹ä¼´å‘çƒ­ï¼ˆæ’é™¤ä¼ æŸ“ç—…ï¼‰
   
   è¡¨è¾¾æ–¹å¼ï¼š"æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œè¿™ç§æƒ…å†µéœ€è¦å°½å¿«åˆ°åŒ»é™¢å°±è¯Šï¼Œå»ºè®®ä»Šå¤©å°±å»çœ‹æ€¥è¯Šã€‚"

3. **ç³»ç»ŸåŒ–é—®è¯Šè¦ç‚¹**
   æŒ‰ç…§æ ‡å‡†çš„çš®è‚¤ç§‘é—®è¯Šæµç¨‹æ”¶é›†ä¿¡æ¯ï¼š
   - ä¸»è¯‰ï¼šæœ€ä¸»è¦çš„çš®è‚¤é—®é¢˜å’ŒæŒç»­æ—¶é—´
   - ç°ç—…å²ï¼šå‘ç—…ç»è¿‡ã€æ¼”å˜è¶‹åŠ¿ã€è¯±å‘å› ç´ 
   - çš®æŸç‰¹å¾ï¼šå½¢æ€ã€é¢œè‰²ã€å¤§å°ã€åˆ†å¸ƒã€æ•°é‡
   - ä¼´éšç—‡çŠ¶ï¼šç˜™ç—’ã€ç–¼ç—›ã€ç¼çƒ­ã€æ¸—æ¶²ç­‰
   - æ—¢å¾€å²ï¼šè¿‡æ•å²ã€ç”¨è¯å²ã€ç±»ä¼¼ç—…å²
   - æ²»ç–—ç»è¿‡ï¼šå·²é‡‡å–çš„æ²»ç–—æªæ–½åŠæ•ˆæœ

ã€ä½•æ—¶ç»™å‡ºè¯Šæ–­å»ºè®®ã€‘
æ ¹æ®ä¸´åºŠä¿¡æ¯çš„å®Œæ•´æ€§åˆ¤æ–­ï¼š

âœ… å¯ä»¥ç»™å‡ºè¯Šæ–­å’Œæ²»ç–—å»ºè®®çš„æƒ…å†µï¼š
- å·²æ”¶é›†åˆ°è¶³å¤Ÿçš„ä¸´åºŠä¿¡æ¯ï¼ˆä¸»è¯‰ã€ç—…å²ã€çš®æŸç‰¹å¾ã€ä¼´éšç—‡çŠ¶ï¼‰
- å¯ä»¥æ˜ç¡®1-3ä¸ªé‰´åˆ«è¯Šæ–­
- æ‚£è€…è¯¢é—®è¯Šæ–­ç»“æœæˆ–æ²»ç–—æ–¹æ¡ˆ
- è¯†åˆ«åˆ°å±æ€¥æƒ…å†µï¼Œéœ€è¦ç«‹å³å»ºè®®å°±åŒ»
- å·²é—®è¯Š3-4è½®ï¼Œä¿¡æ¯åŸºæœ¬å®Œæ•´

âœ… éœ€è¦ç»§ç»­é—®è¯Šçš„æƒ…å†µï¼š
- æ‚£è€…æè¿°è¿‡äºç®€å•ï¼Œç¼ºä¹å…³é”®ä¿¡æ¯
- éœ€è¦æ’é™¤ä¸¥é‡ç–¾ç—…æˆ–å±æ€¥æƒ…å†µ
- é‰´åˆ«è¯Šæ–­éœ€è¦æ›´å¤šä¿¡æ¯æ”¯æŒ
- ç—…å²ä¸æ¸…æ™°ï¼Œéœ€è¦æ˜ç¡®æ—¶é—´çº¿å’Œè¯±å› 

ã€å›å¤æ ¼å¼ã€‘
æ¯æ¬¡å›å¤è¦åŒ…å«ï¼š
1. ä¸“ä¸šçš„åŒ»å­¦è¯„ä¼°å’Œé—®è¯Šå†…å®¹
2. 3-5ä¸ªå¿«æ·é€‰é¡¹ï¼ˆé’ˆå¯¹å½“å‰é—®è¯Šé‡ç‚¹ï¼‰
3. åˆ¤æ–­æ˜¯ç»§ç»­é—®è¯Š(continue)è¿˜æ˜¯ç»™å‡ºè¯Šæ–­(complete)

ã€ä¸“ä¸šè§„èŒƒã€‘
- å¯¹æ‰€æœ‰éƒ¨ä½çš„çš®è‚¤é—®é¢˜éƒ½ä»¥ä¸“ä¸šã€å®¢è§‚çš„æ€åº¦å¯¹å¾…
- å¦‚æœæ‚£è€…æè¿°çš„ä¸æ˜¯çš®è‚¤é—®é¢˜ï¼Œç¤¼è²Œåœ°è¯´æ˜ï¼š"æ ¹æ®æ‚¨çš„æè¿°ï¼Œè¿™å¯èƒ½ä¸å±äºçš®è‚¤ç§‘èŒƒç•´ï¼Œå»ºè®®å’¨è¯¢ç›¸å…³ä¸“ç§‘åŒ»ç”Ÿã€‚"
- ä¸è¦åœ¨å›å¤ä¸­æ·»åŠ å…è´£å£°æ˜ï¼ˆå‰ç«¯ç»Ÿä¸€å±•ç¤ºï¼‰
- ä¿æŒä¸“ä¸šæ€§ï¼Œé¿å…è¿‡åº¦å£è¯­åŒ–æˆ–æƒ…ç»ªåŒ–è¡¨è¾¾
- ä½¿ç”¨åŒ»å­¦æœ¯è¯­æ—¶è¦é™„å¸¦é€šä¿—è§£é‡Š
"""


def create_conversation_orchestrator(llm: LLM = None, multimodal: bool = False) -> Agent:
    """
    åˆ›å»ºå•ä¸€å¯¹è¯ç¼–æ’ Agent
    
    Args:
        llm: LLM å®ä¾‹ï¼Œå¦‚æœä¸º None åˆ™è‡ªåŠ¨åˆ›å»º
        multimodal: æ˜¯å¦å¯ç”¨å¤šæ¨¡æ€èƒ½åŠ›ï¼ˆå›¾ç‰‡åˆ†æï¼‰
    """
    if llm is None:
        llm = create_llm(multimodal=multimodal)
    return Agent(
        role="çš®è‚¤ç§‘ä¸“å®¶åŒ»ç”Ÿ",
        goal="é€šè¿‡ç³»ç»ŸåŒ–é—®è¯Šå’Œçš®è‚¤å½±åƒåˆ†æï¼Œå‡†ç¡®è¯Šæ–­çš®è‚¤ç–¾ç—…å¹¶ç»™å‡ºä¸“ä¸šçš„æ²»ç–—å»ºè®®ã€‚å¦‚æœæ‚£è€…ä¸Šä¼ äº†å›¾ç‰‡ï¼Œè¦è¿›è¡Œè¯¦ç»†çš„çš®è‚¤å½±åƒå­¦åˆ†æã€‚",
        backstory=CONVERSATION_ORCHESTRATOR_BACKSTORY,
        verbose=False,
        allow_delegation=False,
        llm=llm,
        multimodal=multimodal,  # å¯ç”¨å¤šæ¨¡æ€èƒ½åŠ›
        max_iter=10,
        max_retry_limit=2,
    )


def save_image_to_temp(image_base64: str) -> Optional[str]:
    """
    å°† base64 å›¾ç‰‡ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œè¿”å›æ–‡ä»¶è·¯å¾„
    
    Args:
        image_base64: base64 ç¼–ç çš„å›¾ç‰‡ï¼ˆå¯èƒ½å¸¦æœ‰ data:image/xxx;base64, å‰ç¼€ï¼‰
    
    Returns:
        ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œå¤±è´¥è¿”å› None
    """
    try:
        # è§£æ base64ï¼ˆå»æ‰ data:image/xxx;base64, å‰ç¼€ï¼‰
        if ',' in image_base64:
            # æ ¼å¼å¦‚ data:image/jpeg;base64,/9j/4AAQ...
            header, data = image_base64.split(',', 1)
            # ä» header ä¸­æå–æ–‡ä»¶æ‰©å±•å
            if 'png' in header.lower():
                ext = '.png'
            elif 'gif' in header.lower():
                ext = '.gif'
            elif 'webp' in header.lower():
                ext = '.webp'
            else:
                ext = '.jpg'
            image_data = base64.b64decode(data)
        else:
            # çº¯ base64 æ•°æ®
            ext = '.jpg'
            image_data = base64.b64decode(image_base64)
        
        # ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
        import uuid
        filename = f"skin_image_{uuid.uuid4().hex[:8]}{ext}"
        filepath = os.path.join(TEMP_IMAGE_DIR, filename)
        
        with open(filepath, 'wb') as f:
            f.write(image_data)
        
        print(f"[derma_agents] å›¾ç‰‡å·²ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶: {filepath}")
        return filepath
    except Exception as e:
        print(f"[derma_agents] ä¿å­˜å›¾ç‰‡å¤±è´¥: {e}")
        return None


def create_conversation_task(
    agent: Agent,
    state: Dict[str, Any],
    user_input: str,
    image_base64: str = None,
) -> Task:
    """åˆ›å»ºå¯¹è¯ä»»åŠ¡"""
    state_snapshot = _format_state_snapshot(state)
    questions_asked = state.get("questions_asked", 0)
    
    # å¦‚æœæœ‰å›¾ç‰‡ï¼Œä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¹¶æ·»åŠ å›¾ç‰‡åˆ†ææŒ‡ä»¤
    image_info = ""
    image_path = None
    if image_base64:
        image_path = save_image_to_temp(image_base64)
        if image_path:
            image_info = f"""

ğŸ“· **ç”¨æˆ·ä¸Šä¼ äº†ä¸€å¼ çš®è‚¤ç…§ç‰‡**
å›¾ç‰‡è·¯å¾„ï¼š{image_path}

**é‡è¦**ï¼šè¯·ä½¿ç”¨ AddImageTool å·¥å…·åˆ†æè¿™å¼ å›¾ç‰‡ã€‚
- è°ƒç”¨æ–¹å¼ï¼šä½¿ç”¨ image_url å‚æ•°ä¼ å…¥å›¾ç‰‡è·¯å¾„ "{image_path}"
- åˆ†æå›¾ç‰‡ä¸­çš®è‚¤çš„çŠ¶æ€ã€é¢œè‰²ã€å½¢æ€ã€åˆ†å¸ƒç­‰
- ç»“åˆç”¨æˆ·çš„æ–‡å­—æè¿°ç»™å‡ºä¸“ä¸šåˆ¤æ–­
"""
        else:
            image_info = "\n\nğŸ“· ç”¨æˆ·å°è¯•ä¸Šä¼ å›¾ç‰‡ä½†å¤„ç†å¤±è´¥ï¼Œè¯·è¯¢é—®ç”¨æˆ·é‡æ–°ä¸Šä¼ æˆ–æè¿°ç—‡çŠ¶ã€‚"
    
    context = f"""
æœ€è¿‘å¯¹è¯ï¼š
{_format_recent_messages(state.get('messages', []))}

ç»“æ„åŒ–å…³é”®ä¿¡æ¯ï¼š
{state_snapshot}

ç”¨æˆ·æœ€æ–°è¾“å…¥ï¼š{user_input}{image_info}
"""

    # åˆ¤æ–­æ˜¯å¦åº”è¯¥ç»™å‡ºå»ºè®®ï¼ˆåŸºäºå¯¹è¯è‡ªç„¶åº¦ï¼Œè€Œéæœºæ¢°è®¡æ•°ï¼‰
    user_requesting_advice = any(keyword in user_input.lower() for keyword in 
        ["æ€ä¹ˆåŠ", "æ˜¯ä»€ä¹ˆ", "ä»€ä¹ˆé—®é¢˜", "å»ºè®®", "åˆ†æ", "ä¸¥é‡å—", "éœ€è¦", "è¯¥"])
    
    has_enough_info = (
        bool(state.get("chief_complaint")) and 
        bool(state.get("skin_location")) and 
        len(state.get("symptoms", [])) >= 1
    )
    
    conversation_too_long = questions_asked >= 8  # é¿å…è¿‡åº¦è¿½é—®
    
    should_give_advice = user_requesting_advice or (has_enough_info and questions_asked >= 3) or conversation_too_long
    
    advice_hint = ""
    if should_give_advice:
        advice_hint = f"""
ğŸ’¡ æç¤ºï¼šå½“å‰å¯¹è¯å·²ç»æ¯”è¾ƒå……åˆ†ï¼ˆå·²èŠäº† {questions_asked} è½®ï¼‰ï¼Œæˆ–è€…ç”¨æˆ·åœ¨è¯¢é—®å»ºè®®ã€‚
ä½ å¯ä»¥è€ƒè™‘ç»™å‡ºåˆæ­¥åˆ¤æ–­å’Œå»ºè®®äº†ã€‚å¦‚æœä¿¡æ¯è¶³å¤Ÿï¼Œè¾“å‡º stage: "summary", next_action: "complete"ã€‚
å¦‚æœè¿˜æœ‰å…³é”®ä¿¡æ¯ç¼ºå¤±ï¼ˆå¦‚ä¸¥é‡ç—‡çŠ¶éœ€è¦ç¡®è®¤ï¼‰ï¼Œå¯ä»¥ç»§ç»­èŠä¸€ä¸¤å¥å†ç»™å»ºè®®ã€‚
"""
    
    return Task(
        description=f"""ä½ æ­£åœ¨ä½œä¸ºçš®è‚¤ç§‘ä¸“å®¶åŒ»ç”Ÿï¼Œå¯¹æ‚£è€…è¿›è¡Œä¸“ä¸šçš„çš®è‚¤ç—…é—®è¯Šã€‚

{context}
{advice_hint}

é—®è¯Šè¦æ±‚ï¼š

1. **ä¸“ä¸šç³»ç»Ÿçš„é—®è¯Š**
   - æ ¹æ®æ‚£è€…æè¿°ï¼Œç³»ç»Ÿæ€§åœ°æ”¶é›†ä¸´åºŠä¿¡æ¯
   - å¯ä»¥ä¸€æ¬¡è¯¢é—®å¤šä¸ªç›¸å…³é—®é¢˜ï¼Œæé«˜é—®è¯Šæ•ˆç‡
   - ä¾‹å¦‚ï¼š"æ‚¨æè¿°çš„çº¢ç–¹ä¼´æœ‰ç˜™ç—’ï¼Œè¯·é—®å…·ä½“æ˜¯ä»€ä¹ˆæ—¶å€™å¼€å§‹çš„ï¼Ÿçš®ç–¹æ˜¯çªç„¶å‡ºç°è¿˜æ˜¯é€æ¸å¢å¤šï¼Ÿåˆ†å¸ƒåœ¨æ‰‹èƒŒè¿˜æ˜¯æ‰‹å¿ƒï¼Ÿæœ€è¿‘æœ‰æ¥è§¦è¿‡ä»€ä¹ˆæ–°çš„ç‰©å“æˆ–åŒ–å­¦å“å—ï¼Ÿ"

2. **å±•ç¤ºä¸“ä¸šçš„ä¸´åºŠæ€ç»´**
   - åŸºäºç—‡çŠ¶å’Œä½“å¾è¿›è¡Œé‰´åˆ«è¯Šæ–­
   - ä¾‹å¦‚ï¼š"æ ¹æ®æ‚¨æè¿°çš„çº¢æ–‘ã€ä¸˜ç–¹å’Œç˜™ç—’ç—‡çŠ¶ï¼Œç»“åˆå‘ç—…éƒ¨ä½å’Œæ—¶é—´ï¼Œåˆæ­¥è€ƒè™‘æ¥è§¦æ€§çš®ç‚çš„å¯èƒ½æ€§è¾ƒå¤§ã€‚è¿™æ˜¯ä¸€ç§çš®è‚¤æ¥è§¦åˆ°è¿‡æ•åŸåäº§ç”Ÿçš„å…ç–«ååº”ã€‚ä¸ºäº†è¿›ä¸€æ­¥ç¡®è®¤ï¼Œæˆ‘éœ€è¦äº†è§£..."

3. **è¯†åˆ«å±æ€¥æƒ…å†µ**
   å¦‚æœæ‚£è€…æåˆ°ï¼šå‘¼å¸å›°éš¾ã€å¤§é¢ç§¯æ„ŸæŸ“ã€å‘çƒ­ã€å‰§çƒˆç–¼ç—›ç­‰å±æ€¥ç—‡çŠ¶ï¼Œç«‹å³å»ºè®®å°±åŒ»ï¼š
   "æ ¹æ®æ‚¨çš„ç—‡çŠ¶ï¼Œè¿™ç§æƒ…å†µéœ€è¦å°½å¿«åˆ°åŒ»é™¢å°±è¯Šï¼Œå»ºè®®ä»Šå¤©å°±å»çœ‹æ€¥è¯Šã€‚"

4. **ä½•æ—¶ç»™å‡ºè¯Šæ–­å»ºè®®**
   - å¦‚æœæ‚£è€…è¯¢é—®è¯Šæ–­æˆ–æ²»ç–—æ–¹æ¡ˆï¼Œä¸”ä¿¡æ¯å……åˆ†ï¼Œç»™å‡ºå»ºè®®
   - å¦‚æœå·²æ”¶é›†åˆ°è¶³å¤Ÿçš„ä¸´åºŠä¿¡æ¯ï¼ˆä¸»è¯‰ã€ç—…å²ã€çš®æŸç‰¹å¾ï¼‰ï¼Œç»™å‡ºè¯Šæ–­
   - å¦‚æœä¿¡æ¯ä¸è¶³ä»¥æ”¯æŒè¯Šæ–­ï¼Œç»§ç»­ç³»ç»Ÿé—®è¯Š
   - ä¸è¦æœºæ¢°åœ°æ•°é—®é¢˜æ¬¡æ•°ï¼Œè€Œæ˜¯æ ¹æ®ä¿¡æ¯å®Œæ•´æ€§åˆ¤æ–­

5. **ç»™å‡ºè¯Šæ–­å»ºè®®çš„æ–¹å¼**
   å½“å†³å®šç»™å‡ºè¯Šæ–­æ—¶(next_action: "complete", stage: "summary")ï¼š
   - è¯´æ˜è¯Šæ–­ä¾æ®ï¼š"æ ¹æ®æ‚¨æè¿°çš„[ç—‡çŠ¶]ï¼Œç»“åˆ[ç—…å²]ï¼Œåˆæ­¥è€ƒè™‘..."
   - åˆ—å‡º1-3ä¸ªé‰´åˆ«è¯Šæ–­åŠå¯èƒ½æ€§
   - ç»™å‡ºå…·ä½“æ²»ç–—å»ºè®®ï¼ˆè¯ç‰©ã€å‰‚é‡ã€ç–—ç¨‹ã€æ³¨æ„äº‹é¡¹ï¼‰
   - è¯´æ˜é¢„åå’Œå¤è¯ŠæŒ‡å¾
   - ä¾‹å¦‚ï¼š"æ ¹æ®æ‚¨æè¿°çš„æ‰‹èƒŒçº¢æ–‘ã€ä¸˜ç–¹ä¼´ç˜™ç—’ï¼Œç»“åˆæ¥è§¦æ´—æ´ç²¾åå‘ç—…ï¼Œåˆæ­¥è¯Šæ–­ä¸ºæ¥è§¦æ€§çš®ç‚ã€‚å»ºè®®ï¼š1) ç«‹å³åœç”¨è¯¥æ´—æ´ç²¾ 2) å¤–ç”¨æ°¢åŒ–å¯çš„æ¾è½¯è†ï¼Œæ¯æ—¥2æ¬¡ 3) å£æœæŠ—ç»„èƒºè¯ç‰©å¦‚æ°¯é›·ä»–å®š 4) ä¸€èˆ¬1-2å‘¨å¯ç¼“è§£ï¼Œå¦‚3å¤©å†…ç—‡çŠ¶åŠ é‡æˆ–å‡ºç°æ¸—æ¶²ï¼Œè¯·åŠæ—¶å°±è¯Š"

6. **å¿«æ·é€‰é¡¹**
   ç»™å‡º3-5ä¸ªå¿«æ·é€‰é¡¹ï¼Œé’ˆå¯¹å½“å‰é—®è¯Šé‡ç‚¹ï¼š
   - è¯¢é—®ç—‡çŠ¶æ—¶ï¼š"æ˜æ˜¾ç˜™ç—’"ã€"è½»åº¦ç˜™ç—’"ã€"ç–¼ç—›ä¸ºä¸»"ã€"ç˜™ç—’ä¼´ç–¼ç—›"
   - è¯¢é—®è¯±å› æ—¶ï¼š"æ¥è§¦æ–°ç‰©å“"ã€"ä½¿ç”¨æ–°åŒ–å¦†å“"ã€"æ¥è§¦æ¤ç‰©"ã€"æ— æ˜æ˜¾è¯±å› "
   - è¯¢é—®ç—…å²æ—¶ï¼š"é¦–æ¬¡å‘ä½œ"ã€"åå¤å‘ä½œ"ã€"æœ‰è¿‡æ•å²"ã€"ä¸ç¡®å®š"

7. **è¯­è¨€é£æ ¼**
   âœ… "æ ¹æ®æ‚¨çš„æè¿°ï¼Œçš®æŸå‘ˆç°çº¢æ–‘å’Œä¸˜ç–¹ï¼Œä¼´æœ‰æ˜æ˜¾ç˜™ç—’"
   âœ… "åˆæ­¥è€ƒè™‘æ¥è§¦æ€§çš®ç‚çš„å¯èƒ½æ€§è¾ƒå¤§"
   âœ… "å»ºè®®å¤–ç”¨ç³–çš®è´¨æ¿€ç´ è½¯è†ï¼Œä¸€èˆ¬1-2å‘¨å¯ä»¥ç¼“è§£"
   âœ… "å¦‚æœ3å¤©å†…ç—‡çŠ¶åŠ é‡ï¼Œè¯·åŠæ—¶åˆ°åŒ»é™¢å°±è¯Š"
   âŒ "æ‰‹ä¸Šèµ·çº¢ç–¹è¿˜ç—’ï¼Œè¿™ç¡®å®æŒºéš¾å—çš„"ï¼ˆè¿‡äºå£è¯­åŒ–ï¼‰
   âŒ "å¬èµ·æ¥å¯èƒ½æ˜¯..."ï¼ˆä¸å¤Ÿä¸“ä¸šï¼‰

è¾“å‡º JSONï¼š
{{
    "message": "ä¸“ä¸šçš„é—®è¯Šå†…å®¹æˆ–è¯Šæ–­å»ºè®®ï¼ˆå¯ä»¥å¤šå¥è¯ï¼‰",
    "next_action": "continueï¼ˆç»§ç»­é—®è¯Šï¼‰æˆ– completeï¼ˆç»™å‡ºè¯Šæ–­ï¼‰",
    "stage": "collectingï¼ˆæ”¶é›†ä¿¡æ¯ï¼‰æˆ– summaryï¼ˆç»™å‡ºè¯Šæ–­ï¼‰",
    "quick_options": [{{"text": "é€‰é¡¹æ–‡æœ¬", "value": "é€‰é¡¹å€¼", "category": "ç±»åˆ«"}}],
    "extracted_info": {{"chief_complaint": "", "skin_location": "", "duration": "", "symptoms": []}}
}}
""",
        expected_output="JSONæ ¼å¼çš„å¯¹è¯è¾“å‡º",
        agent=agent,
        output_pydantic=ConversationOutput
    )


def create_safety_check_task(
    agent: Agent,
    content: str,
    risk_level: str = "medium"
) -> Task:
    """åˆ›å»ºå®‰å…¨å®¡æŸ¥ä»»åŠ¡"""
    return Task(
        description=f"""å®¡æŸ¥ä»¥ä¸‹AIç”Ÿæˆå†…å®¹çš„å®‰å…¨æ€§å’Œåˆè§„æ€§ã€‚

å¾…å®¡æŸ¥å†…å®¹ï¼š
{content}

é£é™©ç­‰çº§ï¼š{risk_level}

ä»»åŠ¡è¦æ±‚ï¼š
1. æ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«é€‚å½“çš„å…è´£å£°æ˜
2. æ£€æŸ¥æ˜¯å¦æœ‰è¿‡åº¦è¯Šæ–­æˆ–ä¸å½“å»ºè®®
3. å¯¹äºé«˜é£é™©æƒ…å†µï¼Œç¡®ä¿æœ‰å°±åŒ»æé†’
4. å¦‚éœ€ä¿®æ”¹ï¼Œæä¾›ä¿®æ”¹åçš„å†…å®¹

è¾“å‡º JSON æ ¼å¼ï¼š
{{
    "is_safe": true/false,
    "warnings": ["è­¦å‘Š1", "è­¦å‘Š2"],
    "disclaimer": "å…è´£å£°æ˜",
    "modified_message": "ä¿®æ”¹åçš„æ¶ˆæ¯ï¼ˆå¦‚æ— éœ€ä¿®æ”¹åˆ™ä¸ºnullï¼‰"
}}
""",
        expected_output="JSONæ ¼å¼çš„å®‰å…¨å®¡æŸ¥ç»“æœ",
        agent=agent
    )


# ============================================================================
# Helper Functions
# ============================================================================

def _format_recent_messages(messages: List[Dict], limit: int = 10) -> str:
    """æ ¼å¼åŒ–æœ€è¿‘çš„å¯¹è¯æ¶ˆæ¯"""
    recent = messages[-limit:] if len(messages) > limit else messages
    formatted = []
    for msg in recent:
        role = "æ‚£è€…" if msg.get("role") == "user" else "åŒ»ç”Ÿ"
        formatted.append(f"{role}: {msg.get('content', '')}")
    return "\n".join(formatted) if formatted else "æ— å†å²å¯¹è¯"


def _format_state_snapshot(state: Dict[str, Any]) -> str:
    """æ±‡æ€»ç»“æ„åŒ–é—®è¯Šä¿¡æ¯ï¼Œå¸®åŠ© Agent åˆ¤æ–­è¿›å±•"""
    if not state:
        return "æš‚æ— ç»“æ„åŒ–ä¿¡æ¯ï¼ˆå°šæœªæ˜ç¡®ä¸»è¯‰ã€éƒ¨ä½æˆ–æŒç»­æ—¶é—´ï¼‰"

    snapshot = []
    chief = state.get("chief_complaint", "")
    location = state.get("skin_location", "")
    duration = state.get("duration", "")
    symptoms = state.get("symptoms") or []

    # æ˜¾ç¤ºå·²æ”¶é›†çš„ä¿¡æ¯
    if chief:
        snapshot.append(f"- ä¸»è¯‰: {chief}")
    else:
        snapshot.append(f"- ä¸»è¯‰: æœªæ˜ç¡®")
    
    if location:
        snapshot.append(f"- éƒ¨ä½: {location}")
    else:
        snapshot.append(f"- éƒ¨ä½: æœªæ˜ç¡®")
    
    if duration:
        snapshot.append(f"- æŒç»­æ—¶é—´: {duration}")
    else:
        snapshot.append(f"- æŒç»­æ—¶é—´: æœªæ˜ç¡®")
    
    if symptoms:
        symptom_list = ", ".join(symptoms[:5])
        if len(symptoms) > 5:
            symptom_list += " ç­‰"
        snapshot.append(f"- è®°å½•ç—‡çŠ¶: {symptom_list}")
    else:
        snapshot.append(f"- è®°å½•ç—‡çŠ¶: æœªæ˜ç¡®")

    # è®¡ç®—å·²å¡«å……çš„å…³é”®å­—æ®µæ•°é‡
    filled_fields = [
        bool(chief),
        bool(location),
        bool(duration),
        bool(symptoms),
        bool(state.get("symptom_details")),
    ]
    completeness = sum(1 for filled in filled_fields if filled)
    snapshot.append(f"- å…³é”®ä¿¡æ¯æ”¶é›†è¿›åº¦: {completeness}/{len(filled_fields)}")
    snapshot.append(f"- å·²è¿½é—®è½®æ¬¡: {state.get('questions_asked', 0)}")

    return "\n".join(snapshot)


def parse_json_output(output: str) -> Dict[str, Any]:
    """è§£æ Agent è¾“å‡ºçš„ JSON"""
    try:
        if "```json" in output:
            output = output.split("```json")[1].split("```")[0]
        elif "```" in output:
            output = output.split("```")[1].split("```")[0]
        return json.loads(output.strip())
    except (json.JSONDecodeError, IndexError):
        return {}
