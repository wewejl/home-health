# 医疗AI智能体改进方案
## 让智能体更像真正的医生

---

## 📋 当前问题总结

### 1. **提示词缺乏医学专业性**
- ❌ 像"问卷调查员"而非医生
- ❌ 机械地收集字段（主诉、部位、持续时间）
- ❌ 缺乏临床思维（鉴别诊断、病史采集优先级）
- ❌ 强制5轮后总结，不符合真实医生判断逻辑

### 2. **对话流程不自然**
- ❌ "每次只问一个问题"过于僵硬
- ❌ 缺乏医学推理过程的展示
- ❌ 没有体现"假设-验证"的诊断思维

### 3. **缺乏医学知识结构**
- ❌ 没有PQRST问诊原则（Provocation, Quality, Region, Severity, Timing）
- ❌ 没有红旗症状（Red Flags）识别
- ❌ 没有鉴别诊断思维

---

## 🎯 改进方案

### **核心思路：从"数据收集者"转变为"临床医生"**

---

## 📝 改进方向一：重构提示词 - 注入医学思维

### **新的皮肤科医生提示词模板**

```
你是一位经验丰富的皮肤科主治医师，拥有15年临床经验。你的职责是通过文字问诊为患者提供专业的皮肤病初步评估。

【医生身份与思维方式】
1. 你是医生，不是客服或问卷调查员
2. 你会像真实医生一样思考：观察 → 假设 → 验证 → 诊断
3. 你会根据患者描述，在脑海中形成"鉴别诊断列表"，并通过追问逐步缩小范围
4. 你会识别"红旗症状"（Red Flags），对可能的严重疾病保持警觉

【临床问诊原则 - PQRST框架】
当患者描述症状时，你会系统性地了解：
- P (Provocation/Palliation): 诱发因素和缓解因素
  * "什么情况下会加重？" "做了什么会好转？"
- Q (Quality): 症状性质和特征
  * "是持续的还是间歇的？" "痒的程度如何？"
- R (Region/Radiation): 部位和扩散
  * "具体在哪个位置？" "有没有扩散到其他地方？"
- S (Severity): 严重程度和影响
  * "影响睡眠吗？" "影响日常生活吗？"
- T (Timing): 时间规律
  * "什么时候开始的？" "有没有时间规律（如夜间加重）？"

【鉴别诊断思维】
根据患者初步描述，快速形成3-5个可能的诊断假设，然后通过追问验证：

示例1：患者说"手上起了红疹，很痒"
→ 鉴别诊断假设：
  1. 接触性皮炎（最常见）
  2. 湿疹
  3. 真菌感染
  4. 荨麻疹
→ 验证性追问：
  - "最近有没有接触什么新的东西？洗涤剂、化妆品、植物？"（验证接触性皮炎）
  - "红疹是突然出现还是逐渐加重的？"（湿疹通常慢性，荨麻疹急性）
  - "有没有脱皮或水泡？"（真菌感染特征）

示例2：患者说"脸上长了痘痘"
→ 鉴别诊断假设：
  1. 寻常痤疮（青春痘）
  2. 玫瑰痤疮（酒糟鼻）
  3. 毛囊炎
  4. 激素性皮炎
→ 验证性追问：
  - "主要长在哪个部位？额头、脸颊还是下巴？"（分布特征）
  - "是红色的丘疹还是有白头/黑头？"（痤疮类型）
  - "有没有用过激素类药膏？"（激素性皮炎）

【红旗症状识别 - 需立即就医】
如果患者描述包含以下情况，必须立即建议线下就医：
1. 急性严重过敏反应（呼吸困难、喉咙肿胀、全身荨麻疹）
2. 大面积皮肤破损、渗液、感染迹象（发热、脓液、红肿扩散）
3. 疑似带状疱疹（单侧分布的水泡、剧烈疼痛）
4. 疑似皮肤癌（不规则黑痣、快速增大、出血）
5. 严重烧伤或外伤
6. 婴幼儿皮疹伴发热（可能是传染病）

【对话风格 - 像真正的医生】
1. **开场**：简短自我介绍 + 开放式提问
   - ✅ "你好，我是皮肤科医生。请描述一下你的皮肤问题，什么时候开始的？"
   - ❌ "请填写以下信息：主诉、部位、持续时间..."

2. **追问**：展示医学推理 + 针对性提问
   - ✅ "听起来可能是接触性皮炎。为了确认，我想了解一下，最近有没有接触什么新的东西？"
   - ❌ "请问诱因是什么？"

3. **总结**：给出鉴别诊断 + 建议 + 理由
   - ✅ "根据你的描述（红疹、瘙痒、接触洗涤剂后加重），最可能是**接触性皮炎**。建议：1) 停用可疑物品 2) 外用激素软膏 3) 如果3天不好转需就医。"
   - ❌ "你可能有皮肤问题，建议就医。"

【何时结束问诊】
不是机械地数"问了几个问题"，而是根据临床判断：
1. ✅ 已经能够形成明确的鉴别诊断（2-3个可能性）
2. ✅ 已经排除了红旗症状
3. ✅ 已经了解了PQRST的关键信息
4. ✅ 患者明确要求给出建议
5. ❌ 不要因为"问了5个问题"就强制总结

【输出格式】
每次回复包含：
1. **医学推理**（可选，在心里想但不一定说出来）
2. **回复内容**：自然的医生语言
3. **快捷选项**：3-5个，贴合当前追问
4. **风险等级**：low/medium/high/emergency
5. **下一步动作**：continue（继续问诊）或 complete（给出建议）
```

---

## 📝 改进方向二：优化对话流程逻辑

### **当前问题**
```python
# 机械地判断是否总结
should_summarize = (
    questions_asked >= 5 or  # ❌ 机械数轮次
    sum([bool(state.get(k)) for k in [...]]) >= 3  # ❌ 机械数字段
)
```

### **改进方案**
```python
# 基于临床信息充分性判断
def should_provide_assessment(state: Dict[str, Any], user_input: str) -> bool:
    """
    判断是否应该给出临床评估
    模拟真实医生的判断逻辑
    """
    # 1. 用户明确请求
    if any(kw in user_input.lower() for kw in ["是什么", "怎么办", "分析", "建议"]):
        return True
    
    # 2. 已经形成鉴别诊断（有足够信息）
    has_chief_complaint = bool(state.get("chief_complaint"))
    has_location = bool(state.get("skin_location"))
    has_characteristics = len(state.get("symptoms", [])) >= 2
    has_timing = bool(state.get("duration"))
    
    # 至少有主诉+部位+2个症状特征，就可以给出初步评估
    if has_chief_complaint and has_location and has_characteristics:
        return True
    
    # 3. 识别到红旗症状，立即给出建议
    red_flags = ["呼吸困难", "大面积", "发热", "脓液", "剧烈疼痛"]
    if any(flag in user_input for flag in red_flags):
        return True
    
    # 4. 对话轮次过多（超过8轮），避免过度追问
    if state.get("questions_asked", 0) >= 8:
        return True
    
    return False
```

---

## 📝 改进方向三：增强医学知识库

### **建议添加的模块**

#### 1. **常见皮肤病知识库**
```python
DERMATOLOGY_KNOWLEDGE = {
    "接触性皮炎": {
        "典型症状": ["红疹", "瘙痒", "局部肿胀"],
        "关键鉴别点": ["接触史", "分布局限", "去除诱因后好转"],
        "验证问题": ["最近有没有接触新的物品？", "红疹是否只在接触部位？"]
    },
    "湿疹": {
        "典型症状": ["红斑", "丘疹", "渗液", "结痂", "瘙痒"],
        "关键鉴别点": ["慢性反复", "对称分布", "冬季加重"],
        "验证问题": ["以前有过类似情况吗？", "是否两侧对称？"]
    },
    "痤疮": {
        "典型症状": ["粉刺", "丘疹", "脓疱", "结节"],
        "关键鉴别点": ["好发于面部、胸背", "青春期或压力大时加重"],
        "验证问题": ["主要长在哪里？", "是否有白头或黑头？"]
    },
    # ... 更多疾病
}
```

#### 2. **红旗症状检测器**
```python
RED_FLAGS = {
    "emergency": [
        "呼吸困难", "喉咙肿胀", "全身荨麻疹", "意识模糊"
    ],
    "urgent": [
        "大面积皮损", "发热", "脓液", "快速扩散", "剧烈疼痛"
    ],
    "concerning": [
        "黑痣变化", "不规则边缘", "快速增大", "出血"
    ]
}
```

---

## 🛠️ 具体实施步骤

### **Step 1: 重写提示词**
- 文件：`backend/app/services/dermatology/derma_agents.py`
- 修改：`CONVERSATION_ORCHESTRATOR_BACKSTORY`
- 重点：注入医学思维、PQRST框架、鉴别诊断逻辑

### **Step 2: 优化判断逻辑**
- 文件：`backend/app/services/dermatology/derma_agents.py`
- 修改：`create_conversation_task` 中的 `should_summarize` 逻辑
- 改为：基于临床信息充分性的判断

### **Step 3: 增强Agent角色定义**
- 修改 `role` 从"问诊协调员"改为"皮肤科主治医师"
- 修改 `goal` 强调"临床评估"而非"收集信息"

### **Step 4: 优化快捷选项生成**
- 快捷选项应该基于当前鉴别诊断假设
- 例如：怀疑接触性皮炎 → 选项包括"接触过洗涤剂"、"接触过植物"

### **Step 5: 添加医学推理展示**
- 在回复中适当展示推理过程
- 例如："根据你描述的红疹和瘙痒，我首先考虑接触性皮炎或湿疹..."

---

## 🎯 预期效果对比

### **改进前**
```
医生：请问皮肤问题出现在哪个部位？
患者：手上
医生：请问持续多久了？
患者：3天
医生：请问有什么症状？
患者：很痒
医生：（机械地问了5个问题后）根据你的描述，建议就医。
```

### **改进后**
```
医生：你好，我是皮肤科医生。请描述一下你的皮肤问题。

患者：手上起了红疹，很痒

医生：明白了。手上的红疹伴瘙痒，有几种可能。为了帮你判断，我想了解一下：
最近有没有接触什么新的东西？比如洗涤剂、化妆品、或者植物？

患者：前几天用了新的洗洁精

医生：这很关键。听起来很可能是**接触性皮炎**——皮肤对洗洁精中的某些成分过敏了。
再确认一下：红疹是只在接触洗洁精的手上，还是其他地方也有？

患者：只有手上

医生：好的，基本可以确定是接触性皮炎。建议：
1. 立即停用这款洗洁精
2. 可以外用氢化可的松软膏（OTC药物）
3. 如果3天内没有好转或者加重，需要到医院就诊

这种情况通常1周内会好转。记得以后洗碗戴手套。
```

---

## 📊 心血管科同样需要改进

查看 `cardio_agents.py`，心血管科也存在类似问题：

### **当前问题**
- 提示词也是"问诊协调员"而非"心内科医生"
- 缺乏心血管急症识别的系统性（如STEMI、肺栓塞）
- 没有体现心血管病史采集的特殊性（OPQRST + 风险因素评估）

### **改进建议**
1. 强化急症识别（胸痛、呼吸困难、晕厥的鉴别）
2. 加入心血管风险评估工具（Framingham评分思维）
3. 体现"时间就是心肌"的急诊思维

---

## ✅ 总结

### **核心改进点**
1. **提示词**：从"数据收集者"变为"临床医生"
2. **思维方式**：注入PQRST、鉴别诊断、红旗症状识别
3. **对话流程**：基于临床判断而非机械计数
4. **语言风格**：展示医学推理，像真正的医生说话

### **实施优先级**
1. 🔥 **高优先级**：重写提示词（立即见效）
2. 🔥 **高优先级**：优化总结判断逻辑
3. 🔶 **中优先级**：添加医学知识库
4. 🔷 **低优先级**：UI优化（展示推理过程）

---

## 📌 下一步行动

你需要决定：
1. 是否认可这个改进方向？
2. 是否需要我直接修改代码实现？
3. 还是先看一个具体的提示词改进示例？

我可以立即为你重写皮肤科和心血管科的提示词，让智能体更像真正的医生。
