# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Home-Health** (鑫琳医生) is an AI Doctor Avatar System that provides AI-powered medical consultation services. It consists of three main components:

| Component | Technology | Purpose |
|-----------|------------|---------|
| `backend/` | FastAPI + LangGraph + SQLAlchemy | Medical consultation API with multi-agent AI |
| `frontend/` | React 19 + TypeScript + Ant Design | Admin dashboard for doctor/knowledge management |
| `ios/` | SwiftUI + MVVM | Patient mobile app |

## Common Commands

### Backend (FastAPI)

```bash
cd backend

# Install dependencies
pip install -r requirements.txt

# Run development server (port 8000/8100)
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Run specific port
uvicorn app.main:app --reload --port 8100

# Database migration
python migrations/drop_deprecated_sessions_tables.py
```

**API Documentation**: http://localhost:8000/docs (auto-generated by FastAPI)

### Frontend (React + Vite)

```bash
cd frontend

# Install dependencies
npm install

# Run dev server (port 5173)
npm run dev

# Build for production
npm run build

# Lint code
npm run lint

# Preview build
npm run preview
```

### iOS (Xcode)

Open `ios/xinlingyisheng/xinlingyisheng.xcodeproj` in Xcode. Build and run to simulator or device.

**Environment switching**: Edit `ios/xinlingyisheng/xinlingyisheng/Services/APIConfig.swift`:
- Development: `http://localhost:8100`
- Production: `http://apixinling.natapp1.cc`

### iOS Build Commands

```bash
cd ios/xinlingyisheng

# List available schemes
xcodebuild -project xinlingyisheng.xcodeproj -list

# Build for simulator
xcodebuild -project xinlingyisheng.xcodeproj -scheme 鑫琳医生 \
  -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build

# Build for device (requires code signing)
xcodebuild -project xinlingyisheng.xcodeproj -scheme 鑫琳医生 \
  -destination 'generic/platform=iOS' build

# Run tests
xcodebuild test -project xinlingyisheng.xcodeproj -scheme 鑫琳医生 \
  -destination 'platform=iOS Simulator,name=iPhone 17 Pro'
```

## iOS Code Modification Workflow

**CRITICAL**: After modifying ANY iOS code, you MUST follow this verification sequence:

### 1. Compile Check (Required)
```bash
cd ios/xinlingyisheng
xcodebuild -project xinlingyisheng.xcodeproj -scheme 鑫琳医生 \
  -destination 'platform=iOS Simulator,name=iPhone 17 Pro' build
```
- **DO NOT** mark task as complete until `BUILD SUCCEEDED`
- Fix ALL compilation errors before proceeding

### 2. Verify Color/Font Usage
When modifying UI code:
- Use `DXYColors.primaryPurple` - NOT hardcoded colors like `#3B82F6`
- Use `AdaptiveFont.body` - NOT hardcoded sizes like `16`
- Use `ScaleFactor.padding(16)` - NOT hardcoded spacing
- Check that referenced colors exist in DXYColors before using them

### 3. Common Compilation Gotchas
| Error | Fix |
|-------|-----|
| `Type 'DXYColors' has no member 'xxx'` | Use existing DXYColors properties or define inline |
| `Cannot convert value type` | Check color type mismatch (Color vs CGColor) |
| `Use of unresolved identifier` | Missing import or incorrect type name |

### 4. Team Best Practices
- **Local verification first** - Never push untested code
- **Keep replacements consistent** - When refactoring colors, check ALL usages
- **Test visual appearance** - Colors must match the purple theme (#5C44FF)

## Architecture

### Backend - Multi-Agent AI System

The backend uses **LangGraph** for building medical consultation agents with a unified architecture:

```
backend/app/services/agents/
├── base.py           # LangGraphAgent base class - ALL agents inherit this
├── react_base.py     # ReActAgent base class (Observe → Think → Act)
├── router.py         # AgentRouter - centralized agent registry
├── tools/            # Shared agent tools (RAG, image analysis, dossier)
├── general/          # General medicine agent
├── dermatology/      # Dermatology agent (with image recognition)
├── cardiology/       # Cardiology agent
└── orthopedics/      # Orthopedics agent
```

**Key Architecture Rules**:

1. **All agents MUST extend `LangGraphAgent`** from `base.py`
2. **Use unified `sessions` table** - DO NOT create specialty-specific session tables
3. **Use `agent_type` field to distinguish specialties** (dermatology, cardiology, etc.)
4. **Store specialty-specific data in `agent_state` JSONB column**

**Agent Registration** (in `router.py`):
```python
AgentRouter.register(
    agent_type="new_specialty",
    agent_class=NewSpecialtyAgent,
    capabilities={...}
)
```

**Agent Types**:
- `general` - General medicine
- `dermatology` - Dermatology with Qwen-VL image analysis
- `cardiology` - Cardiovascular with ECG interpretation
- `orthopedics` - Orthopedics with X-ray analysis

### Session Management Architecture

**Critical Rule**: Use the unified `sessions` table for ALL specialties. The `agent_type` field distinguishes between different medical specialties.

```python
# Correct: unified sessions table
session = db.query(Session).filter(
    Session.agent_type == "dermatology"
).first()

# Wrong: NEVER create specialty-specific tables
# class DermatologySession(Base): ...  # FORBIDDEN
```

**Session State Flow**:
1. `stage`: greeting → collecting → analyzing → diagnosing → completed
2. `agent_state` (JSONB): stores specialty-specific data (skin_analyses, ecg_data, etc.)
3. `messages`: conversation history with LangChain Message objects

### iOS - MVVM Architecture

```
ios/xinlingyisheng/
├── Models/               # Swift data models (DTOs matching backend schemas)
│   └── UnifiedChatModels.swift
├── Services/             # API communication layer
│   ├── APIConfig.swift   # Environment configuration
│   └── APIService.swift
├── ViewModels/           # Business logic (@MainActor, ObservableObject)
│   └── UnifiedChatViewModel.swift
├── Views/                # SwiftUI views
│   └── ModernConsultationView.swift
├── Components/           # Reusable UI components
│   └── PhotoCapture/
└── Theme/                # Design system (colors, fonts, spacing)
    └── ColorSchemes.swift
```

**iOS Design System Requirements**:
- Use `DXYColors.primaryPurple` for main color - NO hardcoded colors
- Use `AdaptiveFont.body`, `AdaptiveFont.title2` - NO hardcoded font sizes
- Use `ScaleFactor.padding(16)` - NO hardcoded spacing

### Frontend - React with Zustand

```
frontend/src/
├── api/          # API service calls (axios)
├── pages/        # Page components
├── layouts/      # Layout wrappers
└── store/        # Zustand state management
```

## Environment Variables

Key backend `.env` configuration:

```env
# Database (SQLite for dev, PostgreSQL for prod)
DATABASE_URL=sqlite:///./app.db

# JWT Authentication
JWT_SECRET_KEY=your-secret-key
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=480

# LLM Configuration (Aliyun Qwen)
LLM_API_KEY=your-qwen-api-key
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_MODEL=qwen-plus

# Multi-modal for dermatology
QWEN_VL_MODEL=qwen3-vl-plus

# SMS Verification (Aliyun)
ALIYUN_SMS_ACCESS_KEY_ID=your-key
ALIYUN_SMS_ACCESS_KEY_SECRET=your-secret

# Test mode
TEST_MODE=true
ENABLE_SMS_VERIFICATION=false
```

## Default Credentials

| Role | Username | Password |
|------|----------|----------|
| Admin | admin | admin123 |
| Test Token | `test_1` | (for API testing, userId=1) |

## API Contract Reference

The single source of truth for API contracts is `docs/API_CONTRACT.md`. Always verify field types against backend schemas in `backend/app/schemas/`.

**Key field types** (common gotchas):
- `event_id`: String (UUID format), NOT Int
- `session_id`: String (UUID format)
- `agent_type`: String ("dermatology", "cardiology", etc.)
- `created_at`: ISO 8601 datetime string

## Development Workflow

### Adding a New Medical Specialty Agent

1. Create new directory under `backend/app/services/agents/new_specialty/`
2. Create `agent.py` extending `LangGraphAgent`
3. Implement `build_graph()` and `get_capabilities()`
4. Register in `agents/router.py`
5. iOS: No changes needed - uses unified `/sessions` endpoint

### Debugging Agent Issues

```bash
# Backend logs show agent flow
[AgentRouter] Registered: dermatology
[DermatologyReActAgent] Processing input...

# Test with curl
curl -X POST "http://localhost:8000/sessions" \
  -H "Authorization: Bearer test_1" \
  -H "Content-Type: application/json" \
  -d '{"agent_type": "dermatology"}'
```

## Important Files to Know

| File | Purpose |
|------|---------|
| `backend/app/services/agents/base.py` | Base class for all agents - read before modifying agents |
| `backend/app/services/agents/router.py` | Agent registry - add new agents here |
| `backend/app/routes/sessions.py` | Session/message API endpoints |
| `ios/xinlingyisheng/Services/APIConfig.swift` | iOS API endpoints and environment config |
| `docs/DEVELOPMENT_GUIDELINES.md` | Project-wide coding standards |
| `docs/IOS_DEVELOPMENT_GUIDE.md` | iOS-specific development guide |
