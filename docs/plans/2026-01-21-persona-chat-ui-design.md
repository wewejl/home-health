# åŒ»ç”Ÿåˆ†èº«å¯¹è¯å¼é‡‡é›† UI è®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**: 2026-01-21
**çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½
**ä¼˜å…ˆçº§**: P2

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

åŒ»ç”Ÿåˆ†èº«é…ç½®éœ€è¦ç”Ÿæˆ `ai_persona_prompt`ï¼ˆAI äººæ ¼åŒ–æç¤ºè¯ï¼‰ã€‚å½“å‰ `Doctors.tsx` åªæä¾›ç®€å•çš„ TextArea æ‰‹åŠ¨è¾“å…¥ï¼Œç”¨æˆ·ä½“éªŒå·®ã€‚

åç«¯å·²å®Œæ•´å®ç°å¯¹è¯å¼é‡‡é›†æœåŠ¡ï¼š
- `PersonaCollectionService`ï¼š7 ä¸ªé˜¶æ®µçš„å¯¹è¯æµç¨‹
- `/admin/doctors/{id}/persona-chat/*` ç³»åˆ— API

æœ¬è®¾è®¡ä¸ºå‰ç«¯ UIï¼Œæä¾›èŠå¤©å¼äº¤äº’ç•Œé¢ã€‚

### 1.2 ç›®æ ‡

- é€šè¿‡ 7 ä¸ªé˜¶æ®µçš„å¯¹è¯ï¼Œé‡‡é›†åŒ»ç”Ÿè¯Šç–—ç‰¹å¾
- è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–çš„ `ai_persona_prompt`
- 15 åˆ†é’Ÿå†…å®Œæˆå®Œæ•´é…ç½®æµç¨‹

### 1.3 é‡‡é›†é˜¶æ®µ

| é˜¶æ®µ | é‡‡é›†å†…å®¹ |
|------|----------|
| greeting | é—®å€™ä¸è¯´æ˜ |
| specialty | ä¸“ç§‘ç‰¹ç‚¹ï¼ˆç—‡çŠ¶å…³æ³¨ç‚¹ã€å±é™©ä¿¡å·ã€å®å˜±ï¼‰ |
| style | æ²Ÿé€šé£æ ¼ï¼ˆæœ¯è¯­/é€šä¿—ã€ç®€æ´/è¯¦ç»†ã€é€‰æ‹©æƒï¼‰ |
| approach | é—®è¯Šæ€è·¯ï¼ˆé¡ºåºã€æ’é™¤ã€ç¡®è¯Šè€ƒé‡ï¼‰ |
| prescription | å¤„æ–¹ä¹ æƒ¯ï¼ˆä¿å®ˆ/ç§¯æã€ä¸­è¥¿è¯åå¥½ã€ç”¨è¯å®‰å…¨ï¼‰ |
| advice | ç”Ÿæ´»å»ºè®®ï¼ˆé¥®é£Ÿ/ä½œæ¯/è¿åŠ¨/æƒ…ç»ªï¼‰ |
| summary | æ€»ç»“ç¡®è®¤ |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 è·¯ç”±è®¾è®¡

æ–°å»ºç‹¬ç«‹é¡µé¢è·¯ç”±ï¼š
```
/admin/doctors/:id/persona â†’ DoctorPersonaChat.tsx
```

### 2.2 ç»„ä»¶ç»“æ„

```
frontend/src/pages/admin/DoctorPersonaChat.tsx
â”œâ”€â”€ PersonaHeader          # é¡¶éƒ¨ï¼šè¿”å›æŒ‰é’®ã€åŒ»ç”Ÿä¿¡æ¯ã€è¿›åº¦æ¡
â”œâ”€â”€ ChatContainer          # èŠå¤©æ¶ˆæ¯åŒºåŸŸ
â”‚   â”œâ”€â”€ AIMessage         # AI é—®é¢˜æ°”æ³¡ï¼ˆå·¦ä¾§ï¼Œç°è‰²ï¼‰
â”‚   â””â”€â”€ UserMessage       # ç”¨æˆ·å›ç­”æ°”æ³¡ï¼ˆå³ä¾§ï¼Œç´«è‰²ï¼‰
â”œâ”€â”€ StageIndicator        # é˜¶æ®µè¿›åº¦ï¼ˆ7ä¸ªé˜¶æ®µç‚¹ï¼‰
â”œâ”€â”€ InputArea             # åº•éƒ¨è¾“å…¥æ¡† + å‘é€æŒ‰é’®
â””â”€â”€ SummaryCard           # å®Œæˆæ—¶æ˜¾ç¤ºé…ç½®æ‘˜è¦
```

### 2.3 çŠ¶æ€ç®¡ç†

```typescript
interface ChatState {
  messages: Array<{ role: 'ai' | 'user', content: string }>;
  currentStage: CollectionStage;
  collectionState: string;  // JSON åºåˆ—åŒ–çš„ CollectionState
  isComplete: boolean;
  generatedPrompt?: string;
}

enum CollectionStage {
  GREETING = "greeting",
  SPECIALTY = "specialty",
  STYLE = "style",
  APPROACH = "approach",
  PRESCRIPTION = "prescription",
  ADVICE = "advice",
  SUMMARY = "summary"
}
```

---

## 3. API å¯¹æ¥

### 3.1 åˆå§‹åŒ–é‡‡é›†

```typescript
POST /api/admin/doctors/{id}/persona-chat/start

Response:
{
  "message": "æ‚¨å¥½ï¼æˆ‘æ˜¯åŒ»ç”Ÿåˆ†èº«é…ç½®åŠ©æ‰‹...",
  "state": "{\"stage\": \"greeting\", ...}",
  "stage": "greeting",
  "is_complete": false
}
```

### 3.2 å‘é€æ¶ˆæ¯

```typescript
POST /api/admin/doctors/{id}/persona-chat

Request:
{
  "message": "ç”¨æˆ·è¾“å…¥å†…å®¹",
  "state": "ä¸Šæ¬¡è¿”å›çš„ state JSON"
}

Response:
{
  "message": "AI å›å¤å†…å®¹",
  "state": "æ–°çš„ state JSON",
  "stage": "specialty",
  "is_complete": false,
  "generated_prompt": null
}
```

### 3.3 è·å–çŠ¶æ€

```typescript
GET /api/admin/doctors/{id}/persona-status

Response:
{
  "doctor_id": 1,
  "name": "å¼ åŒ»ç”Ÿ",
  "persona_completed": false,
  "has_persona_prompt": true,
  "ai_model": "qwen-plus",
  "ai_temperature": 0.7
}
```

### 3.4 é‡ç½®é…ç½®

```typescript
POST /api/admin/doctors/{id}/persona-chat/reset

Response:
{
  "message": "åŒ»ç”Ÿåˆ†èº«é…ç½®å·²é‡ç½®",
  "doctor_id": 1
}
```

---

## 4. UI è®¾è®¡

### 4.1 é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è¿”å›  å¼ åŒ»ç”Ÿ - åŒ»ç”Ÿåˆ†èº«é…ç½®    [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 2/7        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ğŸ¤– æ‚¨å¥½ï¼æˆ‘æ˜¯åŒ»ç”Ÿåˆ†èº«é…ç½®åŠ©æ‰‹...         â”‚  AI æ¶ˆæ¯   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                         â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                              â”‚ å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹å§  â”‚  ç”¨æˆ·æ¶ˆæ¯â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ã€ä¸“ç§‘ç‰¹ç‚¹ã€‘                             â”‚           â”‚
â”‚  â”‚ é¦–å…ˆè¯·æ‚¨æè¿°ä¸“ç§‘é—®è¯Šæ—¶æœ€å…³æ³¨çš„æ–¹é¢...   â”‚  AI æ¶ˆæ¯   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [__________________________________] [å‘é€ â†‘]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è§†è§‰è§„èŒƒ

| å…ƒç´  | æ ·å¼ |
|------|------|
| AI æ¶ˆæ¯èƒŒæ™¯ | `#f5f5f5`ï¼Œå·¦ä¾§å¯¹é½ï¼Œæœºå™¨äººå›¾æ ‡ |
| ç”¨æˆ·æ¶ˆæ¯èƒŒæ™¯ | `#5C44FF`ï¼ˆä¸»é¢˜è‰²ï¼‰ï¼Œå³ä¾§å¯¹é½ï¼Œç™½è‰²æ–‡å­— |
| è¿›åº¦æ¡ç‚¹ | æœªå®Œæˆï¼šç°è‰²ï¼›å½“å‰ï¼šç´«è‰²ï¼›å·²å®Œæˆï¼šç»¿è‰²å‹¾ |
| è¾“å…¥æ¡† | åœ†è§’ 8pxï¼Œèšç„¦è¾¹æ¡†ç´«è‰² |

### 4.3 é˜¶æ®µè¿›åº¦æŒ‡ç¤ºå™¨

```
[âœ“]â†’[âœ“]â†’[âœ“]â†’[â—]â†’[â—‹]â†’[â—‹]â†’[â—‹]
é—®å€™ ä¸“ç§‘ é£æ ¼ é—®è¯Š å¤„æ–¹ å»ºè®® æ€»ç»“
```

---

## 5. è¾¹ç•Œæƒ…å†µ

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| ç”¨æˆ·åˆ·æ–°é¡µé¢ | å¼¹å‡ºç¡®è®¤ï¼šã€Œé…ç½®è¿›åº¦å°†ä¸¢å¤±ï¼Œç¡®å®šç¦»å¼€ï¼Ÿã€ |
| API è¶…æ—¶/å¤±è´¥ | æ˜¾ç¤ºé‡è¯•æŒ‰é’®ï¼Œä¿ç•™å½“å‰è¾“å…¥ |
| state è§£æå¤±è´¥ | é‡ç½®åˆ° greeting é˜¶æ®µï¼Œæç¤ºã€Œé‡æ–°å¼€å§‹ã€ |
| ç”¨æˆ·è¾“å…¥ã€Œä¿®æ”¹ä¸“ç§‘ã€ | è§£ææŒ‡ä»¤ï¼Œè·³å›å¯¹åº”é˜¶æ®µ |
| ç”Ÿæˆçš„ prompt ä¸ºç©º | æ˜¾ç¤ºè­¦å‘Šï¼šã€Œé…ç½®æœªå®Œæ•´ï¼Œè¯·é‡æ–°é‡‡é›†ã€ |
| ç½‘ç»œä¸­æ–­ | ä¿å­˜æœ€å stateï¼Œé‡è¿åå¯æ¢å¤ |

---

## 6. å…¥å£é›†æˆ

### 6.1 Doctors é¡µé¢æ·»åŠ å…¥å£

åœ¨ `Doctors.tsx` æ“ä½œåˆ—æ·»åŠ æŒ‰é’®ï¼š

```typescript
<Button
  size="small"
  onClick={() => navigate(`/admin/doctors/${record.id}/persona`)}
>
  é…ç½®åˆ†èº«
</Button>
```

### 6.2 App.tsx æ·»åŠ è·¯ç”±

```typescript
{
  path: '/admin/doctors/:id/persona',
  element: <DoctorPersonaChat />,
  requireAuth: true
}
```

---

## 7. å®æ–½æ¸…å•

### 7.1 å‰ç«¯æ–‡ä»¶

- [ ] `frontend/src/pages/admin/DoctorPersonaChat.tsx` - ä¸»ç»„ä»¶
- [ ] `frontend/src/components/persona-chat/` - å­ç»„ä»¶ç›®å½•
  - [ ] `ChatMessage.tsx` - æ¶ˆæ¯æ°”æ³¡ç»„ä»¶
  - [ ] `StageProgress.tsx` - é˜¶æ®µè¿›åº¦æ¡
  - [ ] `SummaryCard.tsx` - é…ç½®æ‘˜è¦å¡ç‰‡
- [ ] `frontend/src/api/persona.ts` - API è°ƒç”¨å°è£…

### 7.2 åç«¯è°ƒæ•´

- [ ] `backend/app/models/doctor.py` - æ·»åŠ  `persona_completed` å­—æ®µï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬

### 7.3 è·¯ç”±é…ç½®

- [ ] `frontend/src/App.tsx` - æ·»åŠ æ–°è·¯ç”±

---

## 8. æµ‹è¯•éªŒæ”¶

- [ ] å®Œæ•´æµç¨‹å¯åœ¨ 5 åˆ†é’Ÿå†…å®Œæˆ
- [ ] æ¯ä¸ªé˜¶æ®µé—®é¢˜æ˜¾ç¤ºæ­£ç¡®
- [ ] ç”¨æˆ·è¾“å…¥æ­£ç¡®ä¼ é€’åˆ°åç«¯
- [ ] state æ­£ç¡®ä¿å­˜å’Œæ¢å¤
- [ ] SUMMARY é˜¶æ®µæ­£ç¡®æ˜¾ç¤ºé…ç½®æ‘˜è¦
- [ ] ã€Œç¡®è®¤ã€å prompt æ­£ç¡®ä¿å­˜åˆ° Doctor è¡¨
- [ ] ã€Œä¿®æ”¹ã€æŒ‡ä»¤å¯æ­£ç¡®è·³è½¬å›å¯¹åº”é˜¶æ®µ
- [ ] ã€Œé‡æ–°å¼€å§‹ã€å¯æ¸…ç©ºçŠ¶æ€
- [ ] åˆ·æ–°é¡µé¢æœ‰ä¿æŠ¤æç¤º
- [ ] ç”Ÿæˆçš„ prompt æ ¼å¼æ­£ç¡®

---

## 9. å‚è€ƒèµ„æ–™

- åç«¯å®ç°ï¼š`backend/app/routes/persona_chat.py`
- æœåŠ¡å±‚ï¼š`backend/app/services/persona_collection_service.py`
- Doctor æ¨¡å‹ï¼š`backend/app/models/doctor.py`
