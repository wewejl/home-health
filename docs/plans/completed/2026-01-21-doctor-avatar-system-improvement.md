# 状态: 已完成

# 医生分身系统完善方案

**日期:** 2026-01-21
**目标:** 完善查病查药数据、界面功能、医生分身创建流程

---

## 一、查病查药真实数据方案

### 1.1 数据源规划

| 数据类型 | 数据源 | 数量 | 说明 |
|---------|--------|------|------|
| **疾病数据** | ICD-10 国家标准编码 | ~1.4万条 | 国家医保版，含疾病编码、名称、分类 |
| **药品数据** | 国家药监局数据库 | ~15万条 | 含批准文号、生产企业、适应症 |

### 1.2 数据导入流程

```
1. 获取公开数据集（CSV/JSON格式）
   ├── 疾病：ICD-10编码映射表
   └── 药品：国家药监局批准药品库

2. 数据清洗与转换
   ├── 统一字段格式
   ├── 建立科室关联
   └── 补充基础信息

3. 批量导入数据库
   ├── 使用 migrations 脚本
   └── 保留原有种子数据

4. 人工补充完善
   ├── 医生后台编辑详情
   ├── 添加症状、诊断、治疗等内容
   └── 审核机制（提交→审核→发布）
```

### 1.3 数据模型补充

现有模型已完善，导入后需补充的字段：
- `overview`, `symptoms`, `causes`, `diagnosis`, `treatment`, `prevention`, `care`
- `indications`, `contraindications`, `dosage`, `side_effects`, `precautions`

---

## 二、界面功能完善方案

### 2.1 iOS 患者端

| 页面 | 优先级 | 待实现功能 |
|------|--------|-----------|
| **查病查药** | P0 | 疾病/药品详情页跳转、完整信息展示 |
| **病历资料夹** | P1 | PDF导出、笔记添加/编辑 |
| **问医生** | P2 | 图片消息、语音消息完整流程 |
| **个人中心** | P2 | 设置页面、意见反馈 |

### 2.2 管理后台

| 页面 | 待实现功能 |
|------|-----------|
| **知识库管理** | 文档上传、重新索引、文档列表 |
| **医生管理** | 编辑、激活/停用、分身配置 |
| **数据统计** | 真实数据图表、趋势分析 |

---

## 三、医生分身创建流程

### 3.1 流程设计

```
┌─────────────────────────────────────────────────────────────┐
│                    医生分身创建流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Step 1: 基础信息录入（管理员操作）                           │
│  ├── 姓名、职称、科室、医院                                  │
│  ├── 头像、简介                                              │
│  └── 创建医生记录                                            │
│         ↓                                                   │
│  Step 2: 对话式采集（医生操作，10-15分钟）                   │
│  ├── AI 引导对话，提取问诊风格                               │
│  │   ├─ "您通常会先问患者什么？"                            │
│  │   ├─ "看到皮损照片，您最关注什么？"                      │
│  │   ├─ "您会给患者哪些生活建议？"                          │
│  │   └─ ...                                                 │
│  ├── AI 实时生成：ai_persona_prompt                         │
│  └─ 医生确认/调整                                           │
│         ↓                                                   │
│  Step 3: 病历分析（可选，提升分身质量）                      │
│  ├── 上传过往病历（脱敏后）                                  │
│  ├── AI 分析：诊断思路、用药习惯                             │
│  └─ 更新 knowledge_base_id                                  │
│         ↓                                                   │
│  Step 4: 分身激活                                           │
│  └── 医生分身上线，开始接待患者                              │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 对话式采集详细设计

**采集维度：**

| 维度 | 采集内容 | 生成字段 |
|------|----------|----------|
| **问诊顺序** | 首诊/复诊的提问习惯 | `ai_persona_prompt` 中的问诊流程 |
| **关注重点** | 最关注的症状/指标 | prompt 中的重点关注项 |
| **沟通风格** | 说话方式（温和/专业/简洁） | prompt 中的语气设定 |
| **处方习惯** | 保守/积极/中等 | prompt 中的用药原则 |
| **生活建议** | 常给患者的建议 | prompt 中的建议模板 |

**对话示例（皮肤科）：**

```
AI：医生您好，我是鑫琳医生系统的助手。今天帮您创建AI分身，
    大概需要10-15分钟。我们从问诊习惯开始聊起。

AI：当患者说"身上痒"时，您通常会怎么问？

医生：我会先问痒了多久，在什么部位，然后问有没有加重或缓解的因素。

AI：明白了，您习惯先了解病史和时间线。那如果患者说这是第一次发病，
    您会接着问什么？

医生：我会问最近有没有换洗衣液、吃过什么药、有没有接触过什么新东西。

AI：好的，您会考虑接触性因素。那看到皮损照片时，您最关注什么？

医生：我看皮损的形态、颜色、分布，还有有没有抓痕。

...（继续对话）

AI：我根据刚才的对话，为您生成了分身的人设提示词，请您确认：

    "你是一位温和亲切的皮肤科医生，擅长湿疹、皮炎、荨麻疹等常见皮肤病。
    问诊时，你习惯先了解病史和时间线，然后询问可能的接触性因素。
    看皮损照片时，你最关注皮损的形态、颜色、分布和抓痕情况..."

医生：这个概括很准确，可以。

AI：太好了！接下来，您要不要上传一些过往的病历？
    这样可以让分身更接近您的真实诊疗风格。

医生：好的，我传几份湿疹的病历。
```

### 3.3 病历分析功能

**输入：** 医生上传的脱敏病历（JSON/CSV格式）

**分析内容：**
- 常用诊断思路
- 处方用药规律
- 随访习惯
- 特殊处理方式

**输出：**
- 更新 `knowledge_base_id`
- 补充 `ai_persona_prompt` 的细节

---

## 四、技术实现要点

### 4.1 数据导入

```python
# backend/scripts/import_medical_data.py
- 支持 ICD-10 CSV 导入
- 支持药监局数据库导入
- 批量处理，进度显示
- 错误日志记录
```

### 4.2 对话式采集

```python
# 新增 API: /admin/doctors/{id}/persona-chat
- WebSocket 长连接对话
- 实时提取并更新 ai_persona_prompt
- 支持医生确认/调整
```

### 4.3 病历分析

```python
# 新增 API: /admin/doctors/{id}/analyze-records
- 上传病历文件
- AI 分析提取特征
- 更新知识库和 prompt
```

---

## 五、数据模型更新

### Doctor 模型（已有，无需改动）

```python
class Doctor(Base):
    # 基础信息
    name, title, department_id, hospital, specialty, intro, avatar_url

    # AI 分身核心
    ai_persona_prompt      # 对话式采集生成
    ai_model               # 默认 qwen-plus
    ai_temperature         # 默认 0.7
    ai_max_tokens          # 默认 500
    knowledge_base_id      # 病历分析后更新
    agent_type             # 默认 simple，可升级为 react
    agent_config           # JSON 配置

    # 状态
    persona_completed      # 新增：对话采集是否完成
    records_analyzed       # 新增：病历分析是否完成
```

---

## 六、实施优先级

| 阶段 | 内容 | 估时 |
|------|------|------|
| **Phase 1** | 查病查药数据导入 | 2-3天 |
| **Phase 2** | iOS 查病查药详情页 | 1-2天 |
| **Phase 3** | 对话式采集功能 | 3-4天 |
| **Phase 4** | 病历分析功能 | 2-3天 |
| **Phase 5** | 其他界面功能完善 | 持续 |

---

## 七、验收标准

- [ ] 疾病库导入 ≥1000 条真实数据
- [ ] 药品库导入 ≥500 条真实数据
- [ ] iOS 查病查药详情页可正常跳转
- [ ] 对话式采集可在15分钟内完成
- [ ] 生成的 ai_persona_prompt 可用
- [ ] 病历分析可正确提取特征

---

*文档版本: v1.0*
