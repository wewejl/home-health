# ä¼šè¯æ•°æ®æµå…¨å±€åˆ†æ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-15  
**ä½œè€…**: ç³»ç»Ÿæ¶æ„åˆ†æ

---

## ğŸ“Š æ ¸å¿ƒé—®é¢˜å›ç­”

### Q: chief_complaintã€symptomsã€skin_locationã€duration è¿™äº›ä¿¡æ¯ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆ**: ä¿å­˜åœ¨ `sessions` è¡¨çš„ `agent_state` JSONå­—æ®µä¸­ã€‚

```sql
-- sessions è¡¨ç»“æ„
CREATE TABLE sessions (
    id VARCHAR(36) PRIMARY KEY,
    user_id INTEGER NOT NULL,
    agent_type VARCHAR(50) DEFAULT 'general',
    agent_state JSON,  -- â† è¿™é‡Œä¿å­˜æ‰€æœ‰å¯¹è¯çŠ¶æ€
    last_message TEXT,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### Q: ç‚¹å‡»"ç”Ÿæˆç—…å†"æŒ‰é’®æ—¶ï¼Œè¿™äº›ä¿¡æ¯ä¼šå…¨éƒ¨ä¼ è¿‡å»å—ï¼Ÿ

**ç­”æ¡ˆ**: ä¸æ˜¯ç›´æ¥ä¼ é€’ï¼Œè€Œæ˜¯**ä»æ•°æ®åº“è¯»å–**ã€‚æµç¨‹å¦‚ä¸‹ï¼š

1. iOS ç‚¹å‡»æŒ‰é’® â†’ è°ƒç”¨ `aggregateSession(sessionId, sessionType)`
2. åç«¯æ¥æ”¶ `session_id` â†’ ä» `sessions` è¡¨æŸ¥è¯¢ `agent_state`
3. ä» `agent_state` æå– `chief_complaint`ã€`symptoms` ç­‰ä¿¡æ¯
4. æ„å»ºå®Œæ•´çš„ä¼šè¯æ•°æ® â†’ ä¿å­˜åˆ° `medical_events` è¡¨

---

## ğŸ”„ å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        iOS å®¢æˆ·ç«¯                                â”‚
â”‚                                                                  â”‚
â”‚  1. ç”¨æˆ·å‘é€æ¶ˆæ¯: "æˆ‘çš®è‚¤å¾ˆç—’"                                   â”‚
â”‚     â†“                                                            â”‚
â”‚  POST /sessions/{session_id}/messages                           â”‚
â”‚     body: { content: "æˆ‘çš®è‚¤å¾ˆç—’", action: "conversation" }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ API å±‚ (sessions.py)                     â”‚
â”‚                                                                  â”‚
â”‚  2. ä»æ•°æ®åº“æ¢å¤ agent_state                                     â”‚
â”‚     state = session.agent_state  # ä» sessions è¡¨è¯»å–           â”‚
â”‚     â†“                                                            â”‚
â”‚  3. è°ƒç”¨æ™ºèƒ½ä½“å¤„ç†                                               â”‚
â”‚     updated_state = await agent.run(                            â”‚
â”‚         state=state,                                            â”‚
â”‚         user_input="æˆ‘çš®è‚¤å¾ˆç—’"                                  â”‚
â”‚     )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ™ºèƒ½ä½“å±‚ (derma_crew_service.py)                    â”‚
â”‚                                                                  â”‚
â”‚  4. CrewAI Agent åˆ†æç”¨æˆ·è¾“å…¥                                    â”‚
â”‚     - æå–ä¸»è¯‰: "çš®è‚¤ç˜™ç—’ä¸é€‚"                                   â”‚
â”‚     - æå–ç—‡çŠ¶: ["pruritus"]                                     â”‚
â”‚     - ç”Ÿæˆå›å¤: "è¯·é—®å…·ä½“éƒ¨ä½..."                                â”‚
â”‚     â†“                                                            â”‚
â”‚  5. æ›´æ–° state                                                   â”‚
â”‚     state["chief_complaint"] = "çš®è‚¤ç˜™ç—’ä¸é€‚"                    â”‚
â”‚     state["symptoms"].append("pruritus")                        â”‚
â”‚     state["questions_asked"] += 1                               â”‚
â”‚     state["stage"] = "collecting"                               â”‚
â”‚     â†“                                                            â”‚
â”‚  6. è¿”å› updated_state                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åç«¯ API å±‚ (sessions.py)                     â”‚
â”‚                                                                  â”‚
â”‚  7. ä¿å­˜æ›´æ–°åçš„çŠ¶æ€åˆ°æ•°æ®åº“                                     â”‚
â”‚     session.agent_state = updated_state  # å†™å…¥ sessions è¡¨     â”‚
â”‚     db.commit()                                                 â”‚
â”‚     â†“                                                            â”‚
â”‚  8. è¿”å› AI å›å¤ç»™ iOS                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        iOS å®¢æˆ·ç«¯                                â”‚
â”‚                                                                  â”‚
â”‚  9. æ˜¾ç¤º AI å›å¤                                                 â”‚
â”‚  10. ç”¨æˆ·ç»§ç»­å¯¹è¯... (é‡å¤æ­¥éª¤ 1-9)                              â”‚
â”‚  11. ç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆç—…å†"æŒ‰é’®                                      â”‚
â”‚      â†“                                                           â”‚
â”‚  POST /medical-events/aggregate                                 â”‚
â”‚      body: { session_id: "xxx", session_type: "dermatology" }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åç«¯èšåˆæ¥å£ (medical_events.py)                  â”‚
â”‚                                                                  â”‚
â”‚  12. ä»æ•°æ®åº“è¯»å–ä¼šè¯æ•°æ®                                        â”‚
â”‚      session = db.query(Session).filter(                        â”‚
â”‚          Session.id == session_id                               â”‚
â”‚      ).first()                                                  â”‚
â”‚      â†“                                                           â”‚
â”‚  13. ä» agent_state æå–ä¿¡æ¯                                     â”‚
â”‚      state = session.agent_state                                â”‚
â”‚      chief_complaint = state.get("chief_complaint")  â† è¿™é‡Œè¯»å– â”‚
â”‚      symptoms = state.get("symptoms")                â† è¿™é‡Œè¯»å– â”‚
â”‚      skin_location = state.get("skin_location")      â† è¿™é‡Œè¯»å– â”‚
â”‚      duration = state.get("duration")                â† è¿™é‡Œè¯»å– â”‚
â”‚      â†“                                                           â”‚
â”‚  14. æ•°æ®å®Œæ•´æ€§éªŒè¯ (æ–°å¢)                                       â”‚
â”‚      if not chief_complaint or not symptoms:                    â”‚
â”‚          raise HTTPException(400, "ä¿¡æ¯ä¸å®Œæ•´")                  â”‚
â”‚      â†“                                                           â”‚
â”‚  15. ä» messages è¡¨è¯»å–å¯¹è¯å†å²                                  â”‚
â”‚      messages = db.query(Message).filter(                       â”‚
â”‚          Message.session_id == session_id                       â”‚
â”‚      ).all()                                                    â”‚
â”‚      â†“                                                           â”‚
â”‚  16. æ„å»ºå®Œæ•´çš„ä¼šè¯æ•°æ®                                          â”‚
â”‚      session_data = {                                           â”‚
â”‚          "session_id": session.id,                              â”‚
â”‚          "chief_complaint": chief_complaint,     â† æ¥è‡ª state   â”‚
â”‚          "symptoms": symptoms,                   â† æ¥è‡ª state   â”‚
â”‚          "skin_location": skin_location,         â† æ¥è‡ª state   â”‚
â”‚          "duration": duration,                   â† æ¥è‡ª state   â”‚
â”‚          "message_count": len(messages),         â† æ¥è‡ª messages â”‚
â”‚          "messages": [...]                       â† æ¥è‡ª messages â”‚
â”‚      }                                                           â”‚
â”‚      â†“                                                           â”‚
â”‚  17. ä¿å­˜åˆ°ç—…å†äº‹ä»¶è¡¨                                            â”‚
â”‚      event = MedicalEvent(                                      â”‚
â”‚          chief_complaint=chief_complaint,                       â”‚
â”‚          sessions=[session_data],  # åŒ…å«å®Œæ•´ä¼šè¯æ•°æ®            â”‚
â”‚          ...                                                    â”‚
â”‚      )                                                           â”‚
â”‚      db.add(event)                                              â”‚
â”‚      db.commit()                                                â”‚
â”‚      â†“                                                           â”‚
â”‚  18. è¿”å›ç»“æœç»™ iOS                                              â”‚
â”‚      return { event_id, is_new_event, ... }                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ æ•°æ®å­˜å‚¨ç»“æ„è¯¦è§£

### 1. sessions è¡¨çš„ agent_state å­—æ®µ

**å®é™…å­˜å‚¨çš„å®Œæ•´ç»“æ„**ï¼ˆæ¥è‡ªçœŸå®æ•°æ®åº“æŸ¥è¯¢ï¼‰:

```json
{
  "session_id": "b3ebf9eb-8695-4ad6-b9b3-5e559dc47997",
  "user_id": 1,
  
  // å¯¹è¯å†å²
  "messages": [
    {
      "role": "user",
      "content": "çš®è‚¤å¾ˆä¸èˆ’æœï¼Œå¾ˆç—’",
      "timestamp": "2026-01-15T12:14:03.142285"
    },
    {
      "role": "assistant",
      "content": "æ‚¨æè¿°çš®è‚¤ç˜™ç—’ä¸”ä¸é€‚...",
      "timestamp": "2026-01-15T12:14:11.149881"
    }
  ],
  
  // â† æ ¸å¿ƒä¿¡æ¯ï¼šè¿™äº›ä¼šè¢«èšåˆæ¥å£è¯»å–
  "chief_complaint": "çš®è‚¤ç˜™ç—’ä¸é€‚",
  "symptoms": ["pruritus"],
  "symptom_details": {},
  "skin_location": "",
  "duration": "",
  
  // åˆ†æç»“æœ
  "skin_analyses": [],
  "latest_analysis": null,
  "report_interpretations": [],
  "latest_interpretation": null,
  
  // é—®è¯Šè¿›åº¦
  "stage": "collecting",
  "progress": 0,
  "questions_asked": 2,
  
  // AI ç”Ÿæˆå†…å®¹
  "current_response": "æ„Ÿè°¢æ‚¨çš„è¡¥å……...",
  "quick_options": [
    {"text": "æœ‰å°ç–™ç˜©å’Œè„±çš®", "value": "papules_and_scaling", "category": "symptoms"},
    {"text": "ä¸»è¦æ˜¯å¤œé—´ç˜™ç—’åŠ é‡", "value": "worse_at_night", "category": "symptoms"}
  ],
  
  // è¯Šæ–­ç»“æœ
  "possible_conditions": [],
  "risk_level": "low",
  "care_advice": "",
  "need_offline_visit": false,
  
  // æ§åˆ¶æ ‡å¿—
  "current_task": "conversation",
  "awaiting_image": false
}
```

### 2. medical_events è¡¨çš„ sessions å­—æ®µ

èšåˆåï¼Œä¼šè¯æ•°æ®è¢«ä¿å­˜åˆ°ç—…å†äº‹ä»¶çš„ `sessions` JSONæ•°ç»„ä¸­ï¼š

```json
{
  "id": 5,
  "title": "çš®è‚¤ç§‘ 2026-01-14",
  "chief_complaint": "çš®è‚¤ç˜™ç—’ä¸é€‚",  // â† ä» agent_state æå–
  "sessions": [  // â† å®Œæ•´ä¼šè¯æ•°æ®æ•°ç»„
    {
      "session_id": "b3ebf9eb-8695-4ad6-b9b3-5e559dc47997",
      "session_type": "dermatology",
      "timestamp": "2026-01-15T12:14:03Z",
      "summary": "çš®è‚¤ç§‘é—®è¯Š - çš®è‚¤ç˜™ç—’ä¸é€‚",
      
      // â† ä» agent_state æå–çš„æ ¸å¿ƒä¿¡æ¯
      "chief_complaint": "çš®è‚¤ç˜™ç—’ä¸é€‚",
      "symptoms": ["pruritus"],
      "skin_location": "",
      "duration": "",
      "risk_level": "low",
      "stage": "collecting",
      "message_count": 5,
      
      // â† ä» messages è¡¨æå–çš„å¯¹è¯å†å²
      "messages": [
        {
          "role": "user",
          "content": "çš®è‚¤å¾ˆä¸èˆ’æœï¼Œå¾ˆç—’",
          "timestamp": "2026-01-15T12:14:03Z",
          "type": "text"
        },
        {
          "role": "assistant",
          "content": "æ‚¨æè¿°çš®è‚¤ç˜™ç—’ä¸”ä¸é€‚...",
          "timestamp": "2026-01-15T12:14:11Z",
          "type": "text"
        }
      ],
      
      // â† ç§‘å®¤ç‰¹å®šæ•°æ®ï¼ˆä» agent_state æå–ï¼‰
      "skin_analyses": [],
      "possible_conditions": [],
      "recommendations": {}
    }
  ]
}
```

---

## ğŸ”‘ å…³é”®ä»£ç è·¯å¾„

### 1. å¯¹è¯æ—¶æ›´æ–° agent_state

**ä½ç½®**: `backend/app/routes/sessions.py:313-315`

```python
# æ›´æ–°ä¼šè¯
session.agent_state = updated_state  # â† ä¿å­˜åˆ°æ•°æ®åº“
session.last_message = ai_content[:100]
db.commit()
```

**æµå¼å“åº”æ—¶**: `backend/app/routes/sessions.py:438-440`

```python
session_obj.agent_state = final_state  # â† ä¿å­˜åˆ°æ•°æ®åº“
session_obj.last_message = ai_content[:100]
db_save.commit()
```

### 2. æ™ºèƒ½ä½“æå–ä¿¡æ¯

**ä½ç½®**: `backend/app/services/dermatology/derma_crew_service.py:187-209`

```python
# ä¸»è¯‰ï¼šå¦‚æœæœ‰æ–°çš„ä¸”æ›´å…·ä½“çš„ï¼Œåˆ™æ›´æ–°
if extracted.get("chief_complaint"):
    new_complaint = extracted["chief_complaint"]
    if new_complaint and new_complaint != "æœªæ˜ç¡®":
        state["chief_complaint"] = new_complaint  # â† æ›´æ–°çŠ¶æ€

# ç—‡çŠ¶ï¼šç´¯ç§¯æ·»åŠ æ–°ç—‡çŠ¶
if extracted.get("symptoms"):
    for symptom in extracted["symptoms"]:
        if symptom and symptom not in state.get("symptoms", []):
            state.setdefault("symptoms", []).append(symptom)  # â† ç´¯ç§¯ç—‡çŠ¶
```

### 3. èšåˆæ—¶è¯»å– agent_state

**ä½ç½®**: `backend/app/routes/medical_events.py:467-490`

```python
# 3. ä» agent_state æå–ä¿¡æ¯
state = session.agent_state or {}
chief_complaint = state.get("chief_complaint", "")  # â† è¯»å–ä¸»è¯‰
symptoms = state.get("symptoms", [])                # â† è¯»å–ç—‡çŠ¶
risk_level = state.get("risk_level", "low")
stage = state.get("stage", "completed")

# 4. æ•°æ®å®Œæ•´æ€§éªŒè¯ (æ–°å¢)
if not chief_complaint or not symptoms:
    if len(messages) < 3:
        raise HTTPException(
            status_code=400,
            detail="ä¼šè¯ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·ç»§ç»­å¯¹è¯æ”¶é›†æ›´å¤šç—‡çŠ¶ä¿¡æ¯åå†ç”Ÿæˆç—…å†"
        )
```

### 4. iOS è°ƒç”¨èšåˆæ¥å£

**ä½ç½®**: `ios/xinlingyisheng/xinlingyisheng/ViewModels/UnifiedChatViewModel.swift:509-528`

```swift
func manuallyGenerateDossier() async {
    guard let sessionId = sessionId else { return }
    guard let agentType = agentType else { return }
    
    do {
        // â† åªä¼  session_id å’Œ session_type
        let response = try await medicalEventService.aggregateSession(
            sessionId: sessionId,
            sessionType: agentType.rawValue
        )
        
        eventId = response.event_id
        isNewEvent = response.is_new_event
        shouldShowDossierPrompt = true
        
        print("[UnifiedChatVM] ç—…å†ç”ŸæˆæˆåŠŸ")
    } catch {
        handleError(error)
    }
}
```

---

## âš ï¸ å½“å‰å­˜åœ¨çš„é—®é¢˜

### é—®é¢˜1: èšåˆæ—¶æœºè¿‡æ—©

**ç°è±¡**: 
- ç”¨æˆ·åˆšå¼€å§‹å¯¹è¯ï¼ˆ2-3æ¡æ¶ˆæ¯ï¼‰å°±ç‚¹å‡»"ç”Ÿæˆç—…å†"
- æ­¤æ—¶ `stage = "greeting"` æˆ– `"collecting"`
- `chief_complaint` å¯èƒ½ä¸ºç©ºæˆ–ä¸å®Œæ•´
- `symptoms` å¯èƒ½ä¸ºç©ºæ•°ç»„

**åŸå› **:
- iOS å®¢æˆ·ç«¯åœ¨å¯¹è¯ç•Œé¢å°±æ˜¾ç¤º"ç”Ÿæˆç—…å†"æŒ‰é’®
- ç”¨æˆ·å¯ä»¥éšæ—¶ç‚¹å‡»ï¼Œä¸ç®¡ä¿¡æ¯æ˜¯å¦æ”¶é›†å®Œæ•´

**è§£å†³æ–¹æ¡ˆ** (å·²å®æ–½):
```python
# åç«¯éªŒè¯ï¼šæ‹’ç»ä¸å®Œæ•´çš„èšåˆè¯·æ±‚
if not chief_complaint or not symptoms:
    if stage in ["greeting", "collecting"]:
        raise HTTPException(400, "æ™ºèƒ½ä½“è¿˜åœ¨æ”¶é›†ä¿¡æ¯é˜¶æ®µï¼Œè¯·ç»§ç»­å¯¹è¯")
```

### é—®é¢˜2: æ—§æ•°æ®æ±¡æŸ“

**ç°è±¡**:
- æ•°æ®åº“ä¸­æœ‰16æ¡æ—§ä¼šè¯è¡¨æ•°æ®ï¼ˆ`derma_sessions`, `diagnosis_sessions`ï¼‰
- æœ‰2ä¸ªç©ºå£³ç—…å†äº‹ä»¶ï¼ˆæ— ä¸»è¯‰ã€æ— ç—‡çŠ¶ï¼‰

**è§£å†³æ–¹æ¡ˆ** (å·²å‡†å¤‡):
```bash
# æ‰§è¡Œæ¸…ç†è„šæœ¬
python scripts/cleanup_incomplete_events.py
```

---

## âœ… ä¼˜åŒ–å»ºè®®

### å»ºè®®1: iOS å®¢æˆ·ç«¯ä¼˜åŒ–æŒ‰é’®æ˜¾ç¤ºé€»è¾‘

**å½“å‰**: æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º

**å»ºè®®**: æ ¹æ®å¯¹è¯é˜¶æ®µåŠ¨æ€æ˜¾ç¤º

```swift
// åœ¨ UnifiedChatViewModel ä¸­æ·»åŠ 
var canGenerateDossier: Bool {
    // è‡³å°‘éœ€è¦5æ¡æ¶ˆæ¯ï¼ˆç”¨æˆ·3æ¡ + AI 2æ¡ï¼‰
    return messages.count >= 5
}

// åœ¨ ChatNavBarV2 ä¸­
if viewModel.canGenerateDossier {
    Button(action: onGenerateDossier) {
        Image(systemName: "doc.text.fill")
    }
}
```

### å»ºè®®2: åç«¯è¿”å›æ›´å‹å¥½çš„é”™è¯¯æç¤º

**å½“å‰**: è¿”å›é€šç”¨é”™è¯¯

**å»ºè®®**: è¿”å›å…·ä½“çš„ç¼ºå¤±ä¿¡æ¯

```python
# åœ¨ medical_events.py ä¸­
if not chief_complaint:
    raise HTTPException(400, detail="å°šæœªæ˜ç¡®ä¸»è¯‰ï¼Œè¯·ç»§ç»­æè¿°æ‚¨çš„ç—‡çŠ¶")
if not symptoms:
    raise HTTPException(400, detail="å°šæœªæ”¶é›†åˆ°ç—‡çŠ¶ä¿¡æ¯ï¼Œè¯·ç»§ç»­å¯¹è¯")
if stage == "greeting":
    raise HTTPException(400, detail="å¯¹è¯åˆšå¼€å§‹ï¼Œè¯·å…ˆæè¿°æ‚¨çš„é—®é¢˜")
```

### å»ºè®®3: æ·»åŠ èšåˆå‰çš„ç¡®è®¤å¯¹è¯æ¡†

**iOS ç«¯æ·»åŠ ç¡®è®¤**:

```swift
func manuallyGenerateDossier() async {
    // æ£€æŸ¥ä¿¡æ¯å®Œæ•´æ€§
    if messages.count < 5 {
        showConfirmation = true
        confirmationMessage = "å¯¹è¯è¾ƒå°‘ï¼Œç”Ÿæˆçš„ç—…å†å¯èƒ½ä¸å®Œæ•´ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ"
        return
    }
    
    // æ‰§è¡Œèšåˆ...
}
```

### å»ºè®®4: æ™ºèƒ½ä½“ä¸»åŠ¨æç¤ºå¯ä»¥ç”Ÿæˆç—…å†

**åœ¨ derma_crew_service.py ä¸­**:

```python
# å½“æ”¶é›†åˆ°è¶³å¤Ÿä¿¡æ¯æ—¶
if (state.get("chief_complaint") and 
    len(state.get("symptoms", [])) >= 2 and
    state.get("skin_location")):
    
    state["can_generate_dossier"] = True
    state["quick_options"].append({
        "text": "ç”Ÿæˆç—…å†èµ„æ–™",
        "value": "generate_dossier",
        "category": "action"
    })
```

---

## ğŸ“ æ€»ç»“

### æ•°æ®ä¿å­˜ä½ç½®

| æ•°æ®é¡¹ | ä¿å­˜ä½ç½® | å­—æ®µè·¯å¾„ |
|--------|---------|---------|
| `chief_complaint` | `sessions.agent_state` | `agent_state.chief_complaint` |
| `symptoms` | `sessions.agent_state` | `agent_state.symptoms` |
| `skin_location` | `sessions.agent_state` | `agent_state.skin_location` |
| `duration` | `sessions.agent_state` | `agent_state.duration` |
| å¯¹è¯å†å² | `messages` è¡¨ | ç‹¬ç«‹è¡¨ï¼Œé€šè¿‡ `session_id` å…³è” |

### æ•°æ®ä¼ é€’æ–¹å¼

**ä¸æ˜¯ç›´æ¥ä¼ é€’ï¼Œè€Œæ˜¯æ•°æ®åº“æŸ¥è¯¢**:

1. iOS åªä¼  `session_id` å’Œ `session_type`
2. åç«¯ä» `sessions` è¡¨è¯»å– `agent_state`
3. åç«¯ä» `messages` è¡¨è¯»å–å¯¹è¯å†å²
4. åç«¯ç»„åˆæ•°æ®åä¿å­˜åˆ° `medical_events` è¡¨

### å…³é”®æ”¹è¿›

1. âœ… æ·»åŠ äº†æ•°æ®å®Œæ•´æ€§éªŒè¯
2. âœ… åˆ›å»ºäº†æ¸…ç†è„šæœ¬
3. ğŸ“‹ å»ºè®®ä¼˜åŒ– iOS æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
4. ğŸ“‹ å»ºè®®æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†
5. ğŸ“‹ å»ºè®®æ™ºèƒ½ä½“ä¸»åŠ¨æç¤º

---

**æ–‡æ¡£ç»´æŠ¤è€…**: ç³»ç»Ÿæ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-15
